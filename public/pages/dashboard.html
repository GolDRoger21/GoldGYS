<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panelim | GOLD GYS</title>

    <link rel="stylesheet" href="/css/app.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F172A'/><text x='50' y='70' font-family='serif' font-size='60' fill='%23D4AF37' text-anchor='middle' font-weight='bold'>G</text><text x='80' y='35' font-size='30'>âš–ï¸</text></svg>">

    <style>
        .dashboard-hero {
            background: linear-gradient(135deg, var(--navy-deep) 0%, #1E293B 100%);
            color: white;
            padding: 40px;
            border-radius: 24px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-strong);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .dashboard-hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 15% 15%, rgba(212,175,55,0.18), transparent 35%),
                        radial-gradient(circle at 85% 10%, rgba(255,255,255,0.12), transparent 30%),
                        radial-gradient(circle at 80% 80%, rgba(212,175,55,0.15), transparent 30%);
            pointer-events: none;
        }
        .dashboard-hero .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            color: var(--gold-light);
            letter-spacing: 0.3px;
        }
        .dashboard-hero .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .dashboard-hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        .dashboard-hero p {
            color: #cbd5e1;
            max-width: 660px;
            font-size: 1.05rem;
            line-height: 1.6;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .hero-overlay-icon {
            position: absolute;
            right: -14px;
            bottom: -28px;
            font-size: 12rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            pointer-events: none;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 22px 20px;
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(0,0,0,0.04);
            display: flex;
            gap: 14px;
            align-items: center;
        }
        .stat-icon {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            font-size: 1.6rem;
            font-weight: 700;
        }
        .stat-details .label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .stat-details .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--navy-deep);
        }
        .stat-details .caption {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 22px;
        }
        .section-card {
            background: white;
            border-radius: 18px;
            padding: 22px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .section-head h3 {
            font-family: 'Playfair Display', serif;
            color: var(--navy-deep);
            font-size: 1.2rem;
        }
        .section-head span { color: var(--text-muted); font-size: 0.9rem; }
        .module-list, .activity-list, .calendar-list { display: flex; flex-direction: column; gap: 12px; }
        .module-card {
            border: 1px solid rgba(0,0,0,0.04);
            border-radius: 14px;
            padding: 14px 16px;
            background: #f8fafc;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }
        .module-card .title { font-weight: 700; color: var(--navy-deep); }
        .module-card .meta { color: var(--text-muted); font-size: 0.9rem; }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: white;
            color: var(--navy-deep);
            border: 1px solid rgba(0,0,0,0.06);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .progress-bar {
            height: 10px;
            background: rgba(15, 23, 42, 0.08);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--gold-main), var(--gold-dark));
        }
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.04);
            align-items: center;
            background: #f8fafc;
        }
        .activity-icon {
            width: 38px; height: 38px;
            border-radius: 10px;
            display: grid; place-items: center;
            font-size: 1.2rem;
            background: rgba(212, 175, 55, 0.15);
        }
        .activity-text { flex: 1; }
        .activity-text .title { font-weight: 700; color: var(--navy-deep); }
        .activity-text .time { color: var(--text-muted); font-size: 0.9rem; }
        .calendar-card { background: var(--navy-deep); color: white; position: relative; overflow: hidden; }
        .calendar-card::after {
            content: "";
            position: absolute;
            top: -40px; right: -40px;
            width: 120px; height: 120px;
            background: var(--gold-main);
            opacity: 0.08;
            border-radius: 50%;
        }
        .calendar-list .event {
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .event strong { color: var(--gold-light); }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .quick-actions a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 14px;
            background: #f8fafc;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            font-weight: 700;
            color: var(--navy-deep);
        }
        .quick-actions a:hover { background: white; box-shadow: var(--shadow-soft); }
        .insight-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid rgba(212, 175, 55, 0.35);
            color: #78350f;
        }
        @media (max-width: 1100px) { .content-grid { grid-template-columns: 1fr; } .app-main { margin-left: 0; width: 100%; } .app-sidebar { display: none; } }
        @media (max-width: 640px) { .dashboard-hero { padding: 28px; } .stat-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
    </style>
</head>
<body>

    <div class="app-layout">

        <aside id="sidebar-area" class="app-sidebar"></aside>

        <main class="app-main">

            <header id="header-area" class="app-header"></header>

            <div class="app-content">

                <section class="dashboard-hero">
                    <div class="badge">âš¡ GYS HÄ±zlandÄ±rÄ±cÄ±</div>
                    <h1>HoÅŸ Geldiniz, <span id="dashUserName" style="color: var(--gold-main);">Kaptan</span> ğŸ‘‘</h1>
                    <p>
                        GÃ¼nlÃ¼k hedeflerinize odaklanÄ±n, eksik konularÄ±nÄ±zÄ± tamamlayÄ±n ve deneme sÄ±navlarÄ±yla seviyenizi gÃ¶rÃ¼n.
                        YolculuÄŸunuza kaldÄ±ÄŸÄ±nÄ±z yerden devam edebilmeniz iÃ§in her ÅŸey hazÄ±r.
                    </p>
                    <div class="actions">
                        <a href="testler.html" class="btn-gold">ğŸ“ Hemen Test Ã‡Ã¶z</a>
                        <a href="denemeler.html" class="btn-navy">ğŸ† Deneme SÄ±navÄ±</a>
                        <a href="yanlislarim.html" class="chip" aria-label="YanlÄ±ÅŸlarÄ±m">âš ï¸ YanlÄ±ÅŸlar</a>
                        <a href="favoriler.html" class="chip" aria-label="Favori sorular">â­ Favoriler</a>
                    </div>
                    <div class="hero-overlay-icon">âš–ï¸</div>
                </section>

                <section class="stat-grid">
                    <article class="stat-card">
                        <div class="stat-icon" style="background: var(--gold-light); color: var(--gold-dark);">ğŸ“š</div>
                        <div class="stat-details">
                            <div class="label">Ã‡Ã¶zÃ¼len Soru</div>
                            <div class="value" id="statSolved">0</div>
                            <div class="caption">Bu hafta hedefin 1000 soru.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon" style="background: #ECFDF5; color: var(--success);">ğŸ¯</div>
                        <div class="stat-details">
                            <div class="label">BaÅŸarÄ± OranÄ±</div>
                            <div class="value" id="statAccuracy">%0</div>
                            <div class="caption">DoÄŸru yanÄ±t yÃ¼zdesi.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon" style="background: #EFF6FF; color: #1D4ED8;">ğŸ”¥</div>
                        <div class="stat-details">
                            <div class="label">Ã‡alÄ±ÅŸma Serisi</div>
                            <div class="value" id="statStreak">0 gÃ¼n</div>
                            <div class="caption">AralÄ±ksÄ±z ilerleme.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon" style="background: #FEF2F2; color: #DC2626;">ğŸ…</div>
                        <div class="stat-details">
                            <div class="label">SÄ±ralama</div>
                            <div class="value" id="statRank">-</div>
                            <div class="caption">Topluluk performansÄ±n.</div>
                        </div>
                    </article>
                </section>

                <section class="content-grid">
                    <div class="column">
                        <article class="section-card">
                            <div class="section-head">
                                <h3>Ã‡alÄ±ÅŸma PlanÄ±</h3>
                                <span>Bu haftanÄ±n odak konularÄ±</span>
                            </div>
                            <div id="moduleList" class="module-list" aria-live="polite"></div>
                        </article>

                        <article class="section-card" style="margin-top: 16px;">
                            <div class="section-head">
                                <h3>Son Aktiviteler</h3>
                                <span>GÃ¼nlÃ¼k ilerleme kayÄ±tlarÄ±</span>
                            </div>
                            <div id="activityList" class="activity-list" aria-live="polite"></div>
                        </article>
                    </div>

                    <div class="column" style="display: flex; flex-direction: column; gap: 16px;">
                        <article class="section-card insight-card">
                            <div class="section-head" style="margin-bottom: 6px;">
                                <h3 style="color: #92400e;">HaftalÄ±k Ã–neri</h3>
                                <span style="color: #b45309;">Fark yaratacak ipucu</span>
                            </div>
                            <p style="color: #713f12; margin-bottom: 8px;">
                                KarmaÅŸÄ±k konularÄ± kÃ¼Ã§Ã¼k bloklara bÃ¶l ve her blok iÃ§in 25 dakikalÄ±k odaklÄ± Ã§alÄ±ÅŸma planla. Blok bitiminde
                                5 dakikalÄ±k kÄ±sa Ã¶zet yazarak Ã¶ÄŸrenmeni pekiÅŸtir.
                            </p>
                            <div class="chip" style="background: white; color: #92400e; border-color: rgba(180,83,9,0.4);">â³ Pomodoro</div>
                        </article>

                        <article class="section-card">
                            <div class="section-head">
                                <h3>HÄ±zlÄ± Ä°ÅŸlemler</h3>
                                <span>Tek dokunuÅŸla baÅŸla</span>
                            </div>
                            <div class="quick-actions">
                                <a href="testler.html">ğŸ§  Yeni Test</a>
                                <a href="denemeler.html">ğŸ“… Deneme</a>
                                <a href="yanlislarim.html">âš ï¸ YanlÄ±ÅŸlarÄ±m</a>
                                <a href="favoriler.html">â­ Favoriler</a>
                                <a href="/">ğŸ° Anasayfa</a>
                                <a href="/profil.html">ğŸ‘¤ Profilim</a>
                            </div>
                        </article>

                        <article class="section-card calendar-card">
                            <div class="section-head">
                                <h3 style="color: var(--gold-main);">SÄ±nav Takvimi</h3>
                                <span style="color: rgba(255,255,255,0.8);">YaklaÅŸan tarihler</span>
                            </div>
                            <div id="calendarList" class="calendar-list"></div>
                        </article>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script type="module">
        import { initLayout } from '/js/ui-loader.js';
        import { auth, db } from '/js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            collection,
            doc,
            getDoc,
            getDocs,
            limit,
            orderBy,
            query
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        initLayout('dashboard');

        const formatter = new Intl.DateTimeFormat('tr-TR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const examTitleCache = new Map();

        function setUserName(user) {
            const nameEl = document.getElementById("dashUserName");
            if (!nameEl) return;

            if (!user) {
                nameEl.innerText = "YÃ¼kleniyorâ€¦";
                return;
            }

            if (user.displayName) {
                nameEl.innerText = user.displayName;
            } else if (user.email) {
                const name = user.email.split('@')[0];
                nameEl.innerText = name.charAt(0).toUpperCase() + name.slice(1);
            } else {
                nameEl.innerText = "KullanÄ±cÄ±";
            }
        }

        function waitForAuthUser() {
            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(
                    auth,
                    (user) => {
                        unsubscribe();
                        resolve(user);
                    },
                    (error) => {
                        unsubscribe();
                        reject(error);
                    }
                );
            });
        }

        function renderStats(stats) {
            document.getElementById('statSolved').innerText = stats.solved.toLocaleString('tr-TR');
            document.getElementById('statAccuracy').innerText = `%${stats.accuracy}`;
            document.getElementById('statStreak').innerText = `${stats.streak} gÃ¼n`;
            document.getElementById('statRank').innerText = stats.rank ? `#${stats.rank}` : '-';
        }

        function renderModules(modules) {
            const container = document.getElementById('moduleList');
            container.innerHTML = '';

            if (!modules.length) {
                container.innerHTML = '<p style="color: var(--text-muted);">HenÃ¼z bir konu hedefi bulunamadÄ±.</p>';
                return;
            }

            modules.forEach((module) => {
                const item = document.createElement('div');
                item.className = 'module-card';
                item.innerHTML = `
                    <div>
                        <div class="title">${module.title}</div>
                        <div class="meta">${module.target}</div>
                        <div class="progress-bar" aria-label="Tamamlanma oranÄ± ${module.completion}%">
                            <span style="width: ${module.completion}%"></span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                        <div class="chip">${module.completion}%</div>
                        ${module.tags.map((tag) => `<div class="chip" style="background:#e2e8f0;">#${tag}</div>`).join('')}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderActivities(activities) {
            const container = document.getElementById('activityList');
            container.innerHTML = '';

            if (!activities.length) {
                container.innerHTML = '<p style="color: var(--text-muted);">HenÃ¼z aktivite kaydÄ± yok.</p>';
                return;
            }

            activities.forEach((activity) => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-text">
                        <div class="title">${activity.title}</div>
                        <div class="time">${activity.time}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderCalendar(events) {
            const container = document.getElementById('calendarList');
            container.innerHTML = '';

            if (!events.length) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.8);">GÃ¶sterilecek sÄ±nav bulunamadÄ±.</p>';
                return;
            }

            events.forEach((event) => {
                const item = document.createElement('div');
                item.className = 'event';
                item.innerHTML = `
                    <strong>${event.title}</strong>
                    <div style="opacity: 0.85;">${event.date}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">${event.note}</div>
                `;
                container.appendChild(item);
            });
        }

        function normalizeDate(value) {
            const date = value?.toDate ? value.toDate() : new Date(value);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function calculateStreak(progressDocs) {
            const days = progressDocs
                .map((p) => p.lastAccessedAt)
                .filter(Boolean)
                .map(normalizeDate)
                .sort((a, b) => b - a);

            if (!days.length) return 0;

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let cursor = today;

            for (const day of days) {
                const diff = (cursor - day) / (1000 * 60 * 60 * 24);
                if (diff === 0) {
                    streak++;
                } else if (diff === 1) {
                    streak++;
                    cursor = day;
                } else if (diff > 1) {
                    break;
                }
            }

            return streak;
        }

        async function fetchUserProgress(uid) {
            try {
                const snap = await getDocs(collection(db, 'users', uid, 'progress'));
                const items = [];
                let attempted = 0;
                let correct = 0;

                snap.forEach((doc) => {
                    const data = doc.data();
                    items.push(data);
                    attempted += data.attemptedQuestions || 0;
                    correct += data.correctAnswers || 0;
                });

                const accuracy = attempted ? Math.round((correct / attempted) * 100) : 0;
                const streak = calculateStreak(items);

                return {
                    progressItems: items,
                    stats: {
                        solved: attempted,
                        accuracy,
                        streak,
                        rank: null
                    }
                };
            } catch (err) {
                console.error('Progress verisi alÄ±namadÄ±', err);
                return { progressItems: [], stats: { solved: 0, accuracy: 0, streak: 0, rank: null } };
            }
        }

        function buildModules(topics, progressItems) {
            const progressMap = new Map();
            progressItems.forEach((item) => {
                if (item.topicId) progressMap.set(item.topicId, item);
            });

            return topics.slice(0, 6).map((topic) => {
                const progress = progressMap.get(topic.id) || {};
                const target = topic.totalQuestionTarget || 0;
                const attempted = progress.attemptedQuestions || 0;
                const completion = target
                    ? Math.min(100, Math.round((attempted / target) * 100))
                    : Math.min(100, Math.round((attempted / 50) * 100));

                return {
                    title: topic.title,
                    completion: Number.isFinite(completion) ? completion : 0,
                    target: target ? `Hedef: ${target} soru` : 'Hedef bilgisi yok',
                    tags: (topic.subTopics || []).slice(0, 2).map((s) => s.title)
                };
            });
        }

        async function fetchTopics() {
            try {
                const topicsQuery = query(collection(db, 'topics'), orderBy('order'));
                const snap = await getDocs(topicsQuery);
                const topics = [];
                snap.forEach((doc) => topics.push({ id: doc.id, ...doc.data() }));
                return topics;
            } catch (err) {
                console.error('Topics alÄ±namadÄ±, orderBy olmadan tekrar denenecek', err);
                const snap = await getDocs(collection(db, 'topics'));
                const topics = [];
                snap.forEach((doc) => topics.push({ id: doc.id, ...doc.data() }));
                return topics;
            }
        }

        async function resolveExamTitle(examId) {
            if (!examId) return 'Deneme SÄ±navÄ±';
            if (examTitleCache.has(examId)) return examTitleCache.get(examId);

            try {
                const examSnap = await getDoc(doc(db, 'exams', examId));
                const title = examSnap.exists() ? examSnap.data().title || `SÄ±nav ${examId}` : `SÄ±nav ${examId}`;
                examTitleCache.set(examId, title);
                return title;
            } catch (err) {
                console.error('Exam baÅŸlÄ±ÄŸÄ± alÄ±namadÄ±', err);
                return `SÄ±nav ${examId}`;
            }
        }

        async function fetchActivities(uid) {
            try {
                const resultsQuery = query(
                    collection(db, 'users', uid, 'examResults'),
                    orderBy('completedAt', 'desc'),
                    limit(4)
                );
                const snap = await getDocs(resultsQuery);
                const activities = await Promise.all(
                    snap.docs.map(async (docSnap) => {
                        const data = docSnap.data();
                        const examTitle = await resolveExamTitle(data.examId);
                        const total = data.totalQuestions || 0;
                        const correct = data.correctAnswers || 0;
                        const ratio = total ? `${correct}/${total}` : 'SonuÃ§';
                        return {
                            icon: 'ğŸ§ ',
                            title: `${examTitle} Â· ${ratio}`,
                            time: data.completedAt ? formatter.format(data.completedAt.toDate()) : 'Tarih bilgisi yok'
                        };
                    })
                );

                return activities;
            } catch (err) {
                console.error('Aktiviteler alÄ±namadÄ±', err);
                return [];
            }
        }

        async function fetchEvents() {
            try {
                const examsQuery = query(collection(db, 'exams'), orderBy('createdAt', 'desc'), limit(3));
                const snap = await getDocs(examsQuery);
                return snap.docs.map((d) => {
                    const data = d.data();
                    const dateLabel = data.createdAt ? formatter.format(data.createdAt.toDate()) : 'Tarih belirtilmemiÅŸ';
                    const note = data.duration ? `${data.duration} dk Â· ${data.totalQuestions || 0} soru` : 'SÃ¼re bilgisi yok';
                    return {
                        title: data.title || 'Deneme sÄ±navÄ±',
                        date: dateLabel,
                        note
                    };
                });
            } catch (err) {
                console.error('SÄ±navlar alÄ±namadÄ±, orderBy olmadan tekrar denenecek', err);
                try {
                    const snap = await getDocs(collection(db, 'exams'));
                    return snap.docs.slice(0, 3).map((d) => {
                        const data = d.data();
                        return {
                            title: data.title || 'Deneme sÄ±navÄ±',
                            date: data.createdAt && data.createdAt.toDate ? formatter.format(data.createdAt.toDate()) : 'Tarih belirtilmemiÅŸ',
                            note: data.duration ? `${data.duration} dk Â· ${data.totalQuestions || 0} soru` : 'SÃ¼re bilgisi yok'
                        };
                    });
                } catch (e) {
                    console.error('SÄ±navlar alÄ±namadÄ±', e);
                    return [];
                }
            }
        }

        async function loadDashboard(user) {
            const [{ progressItems, stats }, topics, activities, events] = await Promise.all([
                fetchUserProgress(user.uid),
                fetchTopics(),
                fetchActivities(user.uid),
                fetchEvents()
            ]);

            renderStats(stats);
            renderModules(buildModules(topics, progressItems));
            renderActivities(activities);
            renderCalendar(events);
        }

        setUserName(null);

        (async () => {
            try {
                const user = await waitForAuthUser();
                if (user) {
                    setUserName(user);
                    await loadDashboard(user);
                } else {
                    window.location.href = "/login.html";
                }
            } catch (err) {
                console.error('Kimlik doÄŸrulama kontrolÃ¼ baÅŸarÄ±sÄ±z', err);
                window.location.href = "/login.html";
            }
        })();
    </script>

</body>
</html>
