<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panelim | GOLD GYS</title>

    <link rel="stylesheet" href="/css/app.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F172A'/><text x='50' y='70' font-family='serif' font-size='60' fill='%23D4AF37' text-anchor='middle' font-weight='bold'>G</text><text x='80' y='35' font-size='30'>‚öñÔ∏è</text></svg>">

    <style>
        .dashboard-hero {
            background: linear-gradient(135deg, var(--color-layer-strong) 0%, var(--color-layer) 100%);
            color: var(--color-text-contrast);
            padding: 40px;
            border-radius: 24px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--color-contrast-soft);
        }
        .dashboard-hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 15% 15%, rgba(212,175,55,0.18), transparent 35%),
                        radial-gradient(circle at 85% 10%, rgba(255,255,255,0.12), transparent 30%),
                        radial-gradient(circle at 80% 80%, rgba(212,175,55,0.15), transparent 30%);
            pointer-events: none;
        }
        .dashboard-hero .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            color: var(--gold-light);
            letter-spacing: 0.3px;
        }
        .dashboard-hero .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .dashboard-hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        .dashboard-hero p {
            color: var(--color-text-muted);
            max-width: 660px;
            font-size: 1.05rem;
            line-height: 1.6;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .hero-overlay-icon {
            position: absolute;
            right: -14px;
            bottom: -28px;
            font-size: 12rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            pointer-events: none;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--color-surface);
            padding: 22px 20px;
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
            display: flex;
            gap: 14px;
            align-items: center;
        }
        .stat-icon {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            font-size: 1.6rem;
            font-weight: 700;
        }
        .stat-details .label {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .stat-details .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--color-text);
        }
        .stat-details .caption {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 22px;
        }
        .column-stack { display: flex; flex-direction: column; gap: 16px; }
        .section-card {
            background: var(--color-surface);
            border-radius: 18px;
            padding: 22px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
        }
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .section-head.compact { margin-bottom: 6px; }
        .section-head h3 {
            font-family: 'Playfair Display', serif;
            color: var(--navy-deep);
            font-size: 1.2rem;
        }
        .section-head span { color: var(--text-muted); font-size: 0.9rem; }
        .module-list, .activity-list, .calendar-list { display: flex; flex-direction: column; gap: 12px; }
        .module-card {
            border: 1px solid var(--color-border);
            border-radius: 14px;
            padding: 14px 16px;
            background: var(--color-surface-alt);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }
        .module-card .title { font-weight: 700; color: var(--color-text); }
        .module-card .meta { color: var(--color-text-muted); font-size: 0.9rem; }
        .module-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .progress-bar {
            height: 10px;
            background: var(--color-border);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--gold-main), var(--gold-dark));
        }
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            align-items: center;
            background: var(--color-surface-alt);
        }
        .activity-icon {
            width: 38px; height: 38px;
            border-radius: 10px;
            display: grid; place-items: center;
            font-size: 1.2rem;
            background: rgba(212, 175, 55, 0.15);
        }
        .activity-text { flex: 1; }
        .activity-text .title { font-weight: 700; color: var(--color-text); }
        .activity-text .time { color: var(--color-text-muted); font-size: 0.9rem; }
        .calendar-card { background: linear-gradient(135deg, var(--color-layer-strong), var(--color-layer)); color: var(--color-text-contrast); position: relative; overflow: hidden; border: 1px solid var(--color-border); }
        .calendar-card::after {
            content: "";
            position: absolute;
            top: -40px; right: -40px;
            width: 120px; height: 120px;
            background: var(--gold-main);
            opacity: 0.08;
            border-radius: 50%;
        }
        .calendar-list .event {
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .event strong { color: var(--gold-light); }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .quick-actions a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 14px;
            background: var(--color-surface-alt);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            font-weight: 700;
            color: var(--color-text);
        }
        .quick-actions a:hover { background: var(--color-surface); box-shadow: var(--shadow-soft); }
        .insight-card {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.18), rgba(212, 175, 55, 0.32));
            border: 1px solid var(--color-primary);
            color: var(--color-layer-strong);
        }
        @media (max-width: 1100px) {
            .content-grid { grid-template-columns: 1fr; }
            .dashboard-hero { padding: 32px; }
            .dashboard-hero h1 { font-size: 1.9rem; }
        }

        @media (max-width: 800px) {
            .dashboard-hero { padding: 26px; }
            .dashboard-hero .actions { width: 100%; }
            .dashboard-hero p { max-width: 100%; }
            .stat-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
            .section-head { align-items: flex-start; flex-direction: column; }
            .quick-actions { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        }

        @media (max-width: 640px) {
            .dashboard-hero { padding: 20px; }
            .dashboard-hero h1 { font-size: 1.65rem; line-height: 1.25; }
            .dashboard-hero .actions { flex-direction: column; align-items: stretch; }
            .dashboard-hero .actions a { width: 100%; justify-content: center; }
            .hero-overlay-icon { font-size: 8rem; right: -10px; bottom: -14px; }

            .stat-grid { grid-template-columns: 1fr; gap: 12px; }
            .stat-card { padding: 18px 16px; align-items: flex-start; }
            .stat-icon { width: 48px; height: 48px; font-size: 1.4rem; }
            .stat-details .value { font-size: 1.5rem; }

            .content-grid { gap: 16px; }
            .section-card { padding: 18px; }

            .module-card { grid-template-columns: 1fr; align-items: flex-start; }
            .module-meta { align-items: flex-start; flex-direction: row; flex-wrap: wrap; gap: 8px; }

            .activity-item { align-items: flex-start; }
            .activity-icon { flex-shrink: 0; }

            .quick-actions { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>

    <div class="app-layout">

        <aside id="sidebar-area" class="app-sidebar"></aside>

        <main class="app-main">

            <header id="header-area" class="app-header"></header>

            <div class="app-content">

                <section class="dashboard-hero">
                    <div class="badge">‚ö° GYS Hƒ±zlandƒ±rƒ±cƒ±</div>
                    <h1>Ho≈ü Geldiniz, <span id="dashUserName" class="text-primary">Kaptan</span> üëë</h1>
                    <p>
                        G√ºnl√ºk hedeflerinize odaklanƒ±n, eksik konularƒ±nƒ±zƒ± tamamlayƒ±n ve deneme sƒ±navlarƒ±yla seviyenizi g√∂r√ºn.
                        Yolculuƒüunuza kaldƒ±ƒüƒ±nƒ±z yerden devam edebilmeniz i√ßin her ≈üey hazƒ±r.
                    </p>
                    <div class="actions">
                        <a href="testler.html" class="btn-gold">üìù Hemen Test √á√∂z</a>
                        <a href="denemeler.html" class="btn-navy">üèÜ Deneme Sƒ±navƒ±</a>
                        <a href="yanlislarim.html" class="chip" aria-label="Yanlƒ±≈ülarƒ±m">‚ö†Ô∏è Yanlƒ±≈ülar</a>
                        <a href="favoriler.html" class="chip" aria-label="Favori sorular">‚≠ê Favoriler</a>
                    </div>
                    <div class="hero-overlay-icon">‚öñÔ∏è</div>
                </section>

                <section class="stat-grid">
                    <article class="stat-card">
                        <div class="stat-icon bg-accent-soft">üìö</div>
                        <div class="stat-details">
                            <div class="label">√á√∂z√ºlen Soru</div>
                            <div class="value" id="statSolved">0</div>
                            <div class="caption">Bu hafta hedefin 1000 soru.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon bg-success-soft">üéØ</div>
                        <div class="stat-details">
                            <div class="label">Ba≈üarƒ± Oranƒ±</div>
                            <div class="value" id="statAccuracy">%0</div>
                            <div class="caption">Doƒüru yanƒ±t y√ºzdesi.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon bg-info-soft">üî•</div>
                        <div class="stat-details">
                            <div class="label">√áalƒ±≈üma Serisi</div>
                            <div class="value" id="statStreak">0 g√ºn</div>
                            <div class="caption">Aralƒ±ksƒ±z ilerleme.</div>
                        </div>
                    </article>
                    <article class="stat-card">
                        <div class="stat-icon bg-danger-soft">üèÖ</div>
                        <div class="stat-details">
                            <div class="label">Sƒ±ralama</div>
                            <div class="value" id="statRank">-</div>
                            <div class="caption">Topluluk performansƒ±n.</div>
                        </div>
                    </article>
                </section>

                <section class="content-grid">
                    <div class="column">
                        <article class="section-card">
                            <div class="section-head">
                                <h3>√áalƒ±≈üma Planƒ±</h3>
                                <span>Bu haftanƒ±n odak konularƒ±</span>
                            </div>
                            <div id="moduleList" class="module-list" aria-live="polite"></div>
                        </article>

                        <article class="section-card mt-md">
                            <div class="section-head">
                                <h3>Son Aktiviteler</h3>
                                <span>G√ºnl√ºk ilerleme kayƒ±tlarƒ±</span>
                            </div>
                            <div id="activityList" class="activity-list" aria-live="polite"></div>
                        </article>
                    </div>

                    <div class="column column-stack">
                        <article class="section-card insight-card">
                            <div class="section-head compact">
                                <h3 class="text-warning-strong">Haftalƒ±k √ñneri</h3>
                                <span class="text-warning">Fark yaratacak ipucu</span>
                            </div>
                            <p class="text-warning-strong mb-xs">
                                Karma≈üƒ±k konularƒ± k√º√ß√ºk bloklara b√∂l ve her blok i√ßin 25 dakikalƒ±k odaklƒ± √ßalƒ±≈üma planla. Blok bitiminde
                                5 dakikalƒ±k kƒ±sa √∂zet yazarak √∂ƒürenmeni peki≈ütir.
                            </p>
                            <div class="chip border-muted text-warning-strong">‚è≥ Pomodoro</div>
                        </article>

                        <article class="section-card">
                            <div class="section-head">
                                <h3>Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                                <span>Tek dokunu≈üla ba≈üla</span>
                            </div>
                            <div class="quick-actions">
                                <a href="testler.html">üß† Yeni Test</a>
                                <a href="denemeler.html">üìÖ Deneme</a>
                                <a href="yanlislarim.html">‚ö†Ô∏è Yanlƒ±≈ülarƒ±m</a>
                                <a href="favoriler.html">‚≠ê Favoriler</a>
                                <a href="/">üè∞ Anasayfa</a>
                                <a href="profil.html">üë§ Profilim</a>
                            </div>
                        </article>

                        <article class="section-card calendar-card">
                            <div class="section-head">
                                <h3 class="text-primary">Sƒ±nav Takvimi</h3>
                                <span class="text-contrast-soft">Yakla≈üan tarihler</span>
                            </div>
                            <div id="calendarList" class="calendar-list"></div>
                        </article>
                    </div>
                </section>

            </div>

            <footer id="footer-area" class="app-footer"></footer>
        </main>
    </div>

  <script type="module">
        import { initLayout } from '/js/ui-loader.js';
        import { auth, db } from '/js/firebase-config.js';
        import { protectPage } from '/js/role-guard.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            collection,
            doc,
            getDoc,
            getDocs,
            limit,
            orderBy,
            query
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Sayfa korumasƒ±nƒ± ba≈ülat
        protectPage();
        initLayout('dashboard');

        const formatter = new Intl.DateTimeFormat('tr-TR', {
            day: '2-digit', month: 'long', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        const examTitleCache = new Map();

        function setUserName(user) {
            const nameEl = document.getElementById("dashUserName");
            if (!nameEl) return;
            if (!user) { nameEl.innerText = "Y√ºkleniyor‚Ä¶"; return; }
            if (user.displayName) {
                nameEl.innerText = user.displayName;
            } else if (user.email) {
                const name = user.email.split('@')[0];
                nameEl.innerText = name.charAt(0).toUpperCase() + name.slice(1);
            } else {
                nameEl.innerText = "Kullanƒ±cƒ±";
            }
        }

        function waitForAuthUser() {
            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, 
                    (user) => { unsubscribe(); resolve(user); },
                    (error) => { unsubscribe(); reject(error); }
                );
            });
        }

        // --- Render Fonksiyonlarƒ± (Aynƒ±) ---
        function renderStats(stats) {
            document.getElementById('statSolved').innerText = stats.solved.toLocaleString('tr-TR');
            document.getElementById('statAccuracy').innerText = `%${stats.accuracy}`;
            document.getElementById('statStreak').innerText = `${stats.streak} g√ºn`;
            document.getElementById('statRank').innerText = stats.rank ? `#${stats.rank}` : '-';
        }

        function renderModules(modules) {
            const container = document.getElementById('moduleList');
            container.innerHTML = '';
            if (!modules.length) {
                container.innerHTML = '<p class="text-muted">Hen√ºz bir konu hedefi bulunamadƒ±.</p>';
                return;
            }
            modules.forEach((module) => {
                const item = document.createElement('div');
                item.className = 'module-card';
                item.innerHTML = `
                    <div>
                        <div class="title">${module.title}</div>
                        <div class="meta">${module.target}</div>
                        <div class="progress-bar"><span style="width: ${module.completion}%"></span></div>
                    </div>
                    <div class="module-meta">
                        <div class="chip">${module.completion}%</div>
                        ${module.tags.map(tag => `<div class="chip bg-soft">#${tag}</div>`).join('')}
                    </div>`;
                container.appendChild(item);
            });
        }

        function renderActivities(activities) {
            const container = document.getElementById('activityList');
            container.innerHTML = '';
            if (!activities.length) {
                container.innerHTML = '<p class="text-muted">Hen√ºz aktivite kaydƒ± yok.</p>';
                return;
            }
            activities.forEach((activity) => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-text">
                        <div class="title">${activity.title}</div>
                        <div class="time">${activity.time}</div>
                    </div>`;
                container.appendChild(item);
            });
        }

        function renderCalendar(events) {
            const container = document.getElementById('calendarList');
            container.innerHTML = '';
            if (!events.length) {
                container.innerHTML = '<p class="text-contrast-soft">G√∂sterilecek sƒ±nav bulunamadƒ±.</p>';
                return;
            }
            events.forEach((event) => {
                const item = document.createElement('div');
                item.className = 'event';
                item.innerHTML = `
                    <strong>${event.title}</strong>
                    <div class="text-contrast-soft text-dimmed">${event.date}</div>
                    <div class="text-contrast-soft caption">${event.note}</div>`;
                container.appendChild(item);
            });
        }

        function normalizeDate(value) {
            const date = value?.toDate ? value.toDate() : new Date(value);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function calculateStreak(progressDocs) {
            const days = progressDocs.map(p => p.lastAccessedAt).filter(Boolean).map(normalizeDate).sort((a, b) => b - a);
            if (!days.length) return 0;
            let streak = 0, cursor = new Date(); cursor.setHours(0,0,0,0);
            for (const day of days) {
                const diff = (cursor - day) / (1000 * 60 * 60 * 24);
                if (diff === 0 || diff === 1) { streak++; if(diff===1) cursor=day; }
                else if (diff > 1) break;
            }
            return streak;
        }

        // --- Veri √áekme Fonksiyonlarƒ± (Hata Yakalamalƒ±) ---

        async function safeFetch(name, fn) {
            try {
                return await fn();
            } catch (error) {
                console.error(`[${name}] Verisi √ßekilemedi:`, error);
                // Kullanƒ±cƒ±ya hatayƒ± g√∂stermek yerine konsola yazƒ±yoruz, UI bo≈ü kalacak
                if (error.code === 'permission-denied') {
                     alert(`YETKƒ∞ HATASI: '${name}' verisini okuyamƒ±yorum. Kurallarƒ± kontrol edin.`);
                }
                return null;
            }
        }

        async function fetchUserProgress(uid) {
            const snap = await getDocs(collection(db, 'users', uid, 'progress'));
            const items = []; let attempted = 0, correct = 0;
            snap.forEach(doc => {
                const d = doc.data(); items.push(d);
                attempted += d.attemptedQuestions || 0; correct += d.correctAnswers || 0;
            });
            const accuracy = attempted ? Math.round((correct / attempted) * 100) : 0;
            const streak = calculateStreak(items);
            return { progressItems: items, stats: { solved: attempted, accuracy, streak, rank: null } };
        }

        function buildModules(topics, progressItems) {
            const progressMap = new Map();
            progressItems.forEach(item => { if (item.topicId) progressMap.set(item.topicId, item); });
            return topics.slice(0, 6).map(topic => {
                const progress = progressMap.get(topic.id) || {};
                const target = topic.totalQuestionTarget || 0;
                const attempted = progress.attemptedQuestions || 0;
                const completion = target ? Math.min(100, Math.round((attempted / target) * 100)) : 0;
                return {
                    title: topic.title, completion,
                    target: target ? `Hedef: ${target} soru` : 'Hedef yok',
                    tags: (topic.subTopics || []).slice(0, 2).map(s => s.title)
                };
            });
        }

        async function fetchTopics() {
            try {
                const q = query(collection(db, 'topics'), orderBy('order'));
                const snap = await getDocs(q);
                const topics = []; snap.forEach(d => topics.push({ id: d.id, ...d.data() }));
                return topics;
            } catch (e) {
                const snap = await getDocs(collection(db, 'topics'));
                const topics = []; snap.forEach(d => topics.push({ id: d.id, ...d.data() }));
                return topics;
            }
        }

        async function resolveExamTitle(examId) {
            if (!examId) return 'Deneme';
            if (examTitleCache.has(examId)) return examTitleCache.get(examId);
            try {
                const snap = await getDoc(doc(db, 'exams', examId));
                const t = snap.exists() ? snap.data().title : `Sƒ±nav ${examId}`;
                examTitleCache.set(examId, t); return t;
            } catch { return `Sƒ±nav ${examId}`; }
        }

        async function fetchActivities(uid) {
            const q = query(collection(db, 'users', uid, 'examResults'), orderBy('completedAt', 'desc'), limit(4));
            const snap = await getDocs(q);
            return await Promise.all(snap.docs.map(async d => {
                const data = d.data();
                const title = await resolveExamTitle(data.examId);
                const ratio = data.totalQuestions ? `${data.correctAnswers}/${data.totalQuestions}` : 'Sonu√ß';
                return { icon: 'üß†', title: `${title} ¬∑ ${ratio}`, time: data.completedAt ? formatter.format(data.completedAt.toDate()) : '' };
            }));
        }

        async function fetchEvents() {
            try {
                const q = query(collection(db, 'exams'), orderBy('createdAt', 'desc'), limit(3));
                const snap = await getDocs(q);
                return snap.docs.map(d => {
                    const data = d.data();
                    return {
                        title: data.title || 'Deneme',
                        date: data.createdAt ? formatter.format(data.createdAt.toDate()) : '',
                        note: `${data.duration || 0} dk ¬∑ ${data.totalQuestions || 0} soru`
                    };
                });
            } catch (err) {
                // Sƒ±ralama hatasƒ± varsa d√ºz √ßekmeyi dene
                const snap = await getDocs(collection(db, 'exams'));
                return snap.docs.slice(0, 3).map(d => {
                     const data = d.data();
                     return { title: data.title || 'Deneme', date: '', note: '' };
                });
            }
        }

        async function loadDashboard(user) {
            // Hepsini ayrƒ± ayrƒ± g√ºvenli ≈üekilde √ßaƒüƒ±rƒ±yoruz
            console.log("Dashboard verileri y√ºkleniyor...");
            
            const progressData = await safeFetch('ƒ∞lerleme Verisi', () => fetchUserProgress(user.uid));
            const topics = await safeFetch('Konular', () => fetchTopics());
            const activities = await safeFetch('Aktiviteler', () => fetchActivities(user.uid));
            const events = await safeFetch('Sƒ±nav Takvimi', () => fetchEvents());

            // UI Render (Veri gelmeyen kƒ±sƒ±mlar bo≈ü ge√ßilecek)
            const safeProgress = progressData || { progressItems: [], stats: { solved:0, accuracy:0, streak:0, rank:null } };
            const safeTopics = topics || [];
            const safeActivities = activities || [];
            const safeEvents = events || [];

            renderStats(safeProgress.stats);
            renderModules(buildModules(safeTopics, safeProgress.progressItems));
            renderActivities(safeActivities);
            renderCalendar(safeEvents);
        }

        setUserName(null);

        (async () => {
            try {
                const user = await waitForAuthUser();
                if (user) {
                    setUserName(user);
                    await loadDashboard(user);
                } else {
                    window.location.href = "/login.html";
                }
            } catch (err) {
                console.error('Kritik Dashboard Hatasƒ±:', err);
                alert("Dashboard ba≈ülatƒ±lamadƒ±: " + err.message);
            }
        })();
    </script>

</body>
</html>