<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilim | GOLD GYS</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    /* --- PROFİL SAYFASI ÖZEL STİLLERİ --- */
    
    .profile-layout {
      display: grid;
      grid-template-columns: 300px 1fr; /* Sol: Kart, Sağ: İçerik */
      gap: 24px;
      align-items: start;
    }

    /* Sol Taraf: Kimlik Kartı */
    .profile-card {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    /* Kartın üstündeki altın süsleme */
    .profile-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 6px;
      background: var(--gold-gradient);
    }

    .profile-avatar-xl {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--navy-deep);
      color: var(--gold-main);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 800;
      margin: 0 auto 16px;
      border: 4px solid #f8fafc;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .profile-name { font-size: 1.25rem; font-weight: 800; color: var(--navy-deep); margin-bottom: 4px; }
    .profile-email { color: var(--text-muted); font-size: 0.9rem; word-break: break-all; margin-bottom: 16px; }
    
    .profile-meta {
      background: #f8fafc;
      border-radius: 12px;
      padding: 12px;
      margin-top: 20px;
      text-align: left;
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meta-row { display: flex; justify-content: space-between; color: var(--navy-light); }
    .meta-row span:first-child { font-weight: 600; color: var(--text-muted); }

    /* Sağ Taraf: İstatistikler ve Ayarlar */
    .profile-main {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* İstatistik Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); }

    .stat-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      background: #f0f9ff;
      color: #0369a1;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }
    .stat-icon.gold { background: #fefce8; color: #ca8a04; }
    .stat-icon.green { background: #f0fdf4; color: #15803d; }

    .stat-info h3 { margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--navy-deep); }
    .stat-info p { margin: 0; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }

    /* Ayarlar Kutusu */
    .settings-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .settings-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e2e8f0;
    }
    .settings-header h2 { margin: 0; font-family: var(--font-serif); color: var(--navy-deep); }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-weight: 700; color: var(--navy-deep); font-size: 0.9rem; }
    
    /* INPUT OKUNABİLİRLİK DÜZELTMESİ */
    .form-group input, 
    .form-group select {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #cbd5e1; /* Gri Kenarlık */
      background: #f8fafc;      /* Çok açık gri zemin */
      color: #0f172a;           /* Koyu lacivert yazı */
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      background: white;
      border-color: var(--gold-main);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
    }

    .form-group input:disabled {
      background: #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
    }

    /* MOBİL DÜZENLEMELERİ */
    @media (max-width: 900px) {
      .profile-layout {
        grid-template-columns: 1fr; /* Mobilde tek sütun */
      }
      .form-grid {
        grid-template-columns: 1fr; /* Mobilde formlar alt alta */
      }
      .profile-card {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .profile-meta {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside id="sidebar-area" class="app-sidebar"></aside>

    <main class="app-main">
      <header id="header-area" class="app-header"></header>

      <div class="app-content">
        
        <div id="profileLoader" style="text-align: center; padding: 50px;">
          <div class="spinner" style="margin: 0 auto 10px;"></div>
          <p class="muted">Profil bilgileriniz yükleniyor...</p>
        </div>

        <div id="profileContainer" class="profile-layout" style="display: none;">
          
          <aside>
            <div class="profile-card">
              <div class="profile-avatar-xl" id="displayAvatar">
                </div>
              <h2 class="profile-name" id="displayNameTitle">-</h2>
              <div class="profile-email" id="displayEmail">-</div>
              
              <div class="badge active" id="displayRole" style="display:inline-block; margin-bottom:15px;">Öğrenci</div>

              <div class="profile-meta">
                <div class="meta-row">
                  <span>Üyelik Durumu:</span>
                  <span id="displayStatus" style="color:var(--success)">Aktif</span>
                </div>
                <div class="meta-row">
                  <span>Kayıt Tarihi:</span>
                  <span id="displayCreated">-</span>
                </div>
                <div class="meta-row">
                  <span>Son Giriş:</span>
                  <span id="displayLastLogin">-</span>
                </div>
              </div>
            </div>
          </aside>

          <div class="profile-main">
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon gold">★</div>
                <div class="stat-info">
                  <h3 id="statTotalTests">0</h3>
                  <p>Çözülen Test</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon green">✔</div>
                <div class="stat-info">
                  <h3 id="statSuccessRate">%0</h3>
                  <p>Başarı Oranı</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">✎</div>
                <div class="stat-info">
                  <h3 id="statTotalQuestions">0</h3>
                  <p>Çözülen Soru</p>
                </div>
              </div>
            </div>

            <div class="settings-box">
              <div class="settings-header">
                <h2>Hesap Bilgileri</h2>
              </div>
              
              <form id="profileForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="inputName" placeholder="Adınız Soyadınız">
                  </div>
                  
                  <div class="form-group">
                    <label>E-posta Adresi</label>
                    <input type="email" id="inputEmail" disabled title="E-posta değiştirilemez">
                    <small style="color:#94a3b8; font-size:0.75rem;">E-posta adresinizi değiştirmek için yöneticiyle iletişime geçin.</small>
                  </div>

                  <div class="form-group">
                    <label>Tema Tercihi</label>
                    <select id="inputTheme">
                      <option value="light">Aydınlık (Varsayılan)</option>
                      <option value="dark" disabled>Karanlık (Yakında)</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Bildirim İzinleri</label>
                    <select id="inputNotifications">
                      <option value="true">Açık</option>
                      <option value="false">Kapalı</option>
                    </select>
                  </div>
                </div>

                <div style="margin-top: 24px; text-align: right;">
                  <button type="submit" class="btn-navy" id="saveBtn">Değişiklikleri Kaydet</button>
                </div>
              </form>
            </div>

          </div>
        </div>

      </div>

      <footer id="footer-area" class="app-footer"></footer>
    </main>
  </div>

  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <script type="module">
    import { auth, db } from "/js/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { initLayout } from "/js/ui-loader.js";
    import { ensureUserDocument } from "/js/user-profile.js";

    const loader = document.getElementById("profileLoader");
    const container = document.getElementById("profileContainer");
    
    // UI Elements
    const els = {
      avatar: document.getElementById("displayAvatar"),
      title: document.getElementById("displayNameTitle"),
      email: document.getElementById("displayEmail"),
      role: document.getElementById("displayRole"),
      status: document.getElementById("displayStatus"),
      created: document.getElementById("displayCreated"),
      lastLogin: document.getElementById("displayLastLogin"),
      inputName: document.getElementById("inputName"),
      inputEmail: document.getElementById("inputEmail"),
      form: document.getElementById("profileForm"),
      saveBtn: document.getElementById("saveBtn"),
      stats: {
        tests: document.getElementById("statTotalTests"),
        rate: document.getElementById("statSuccessRate"),
        questions: document.getElementById("statTotalQuestions")
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        initLayout("student"); // Sidebar'ı yükle
        await loadUserProfile(user);
      } else {
        window.location.href = "/login.html";
      }
    });

    async function loadUserProfile(user) {
      try {
        // Profil verisini garantile (eksikse oluştur)
        await ensureUserDocument(user);
        
        // Güncel veriyi çek
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        
        if (snap.exists()) {
          renderProfile(snap.data(), user);
        }
      } catch (error) {
        console.error("Profil yüklenirken hata:", error);
        alert("Profil bilgileri alınamadı.");
      } finally {
        loader.style.display = "none";
        container.style.display = "grid";
      }
    }

    function renderProfile(data, userAuth) {
      // 1. Sol Kart Bilgileri
      const name = data.displayName || userAuth.displayName || "İsimsiz Kullanıcı";
      const email = data.email || userAuth.email;
      
      // Avatar (Baş harfler)
      const initials = name.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();
      els.avatar.textContent = initials;
      
      els.title.textContent = name;
      els.email.textContent = email;
      els.role.textContent = (data.role || "student").toUpperCase();
      
      // Tarihler
      if (data.createdAt && data.createdAt.toDate) {
        els.created.textContent = data.createdAt.toDate().toLocaleDateString("tr-TR");
      }
      if (data.lastLoginAt && data.lastLoginAt.toDate) {
        els.lastLogin.textContent = data.lastLoginAt.toDate().toLocaleString("tr-TR");
      } else {
        els.lastLogin.textContent = "Şimdi";
      }

      // 2. Form Bilgileri
      els.inputName.value = name;
      els.inputEmail.value = email;

      // 3. İstatistikler (Varsa)
      if (data.stats) {
        els.stats.tests.textContent = data.stats.completedTests || 0;
        els.stats.questions.textContent = data.stats.totalQuestionsSolved || 0;
        
        // Başarı oranı hesaplama
        let rate = 0;
        if (data.stats.totalQuestionsSolved > 0) {
            rate = (data.stats.totalCorrect / data.stats.totalQuestionsSolved) * 100;
        }
        els.stats.rate.textContent = `%${rate.toFixed(1)}`;
      }
    }

    // KAYDETME İŞLEMİ
    els.form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newName = els.inputName.value.trim();
      const user = auth.currentUser;

      if (!newName) {
        alert("İsim alanı boş bırakılamaz.");
        return;
      }

      els.saveBtn.disabled = true;
      els.saveBtn.textContent = "Kaydediliyor...";

      try {
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, {
          displayName: newName,
          updatedAt: serverTimestamp()
        });
        
        // Arayüzü güncelle
        els.title.textContent = newName;
        // Baş harfleri güncelle
        const initials = newName.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();
        els.avatar.textContent = initials;

        showToast("Profil başarıyla güncellendi!");
      } catch (error) {
        console.error("Güncelleme hatası:", error);
        alert("Bir hata oluştu: " + error.message);
      } finally {
        els.saveBtn.disabled = false;
        els.saveBtn.textContent = "Değişiklikleri Kaydet";
      }
    });

    function showToast(msg) {
      const toast = document.createElement("div");
      toast.className = "toast success";
      toast.textContent = msg;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>