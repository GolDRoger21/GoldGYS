<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Update Topics Target Questions</title>
</head>

<body>
    <h1>Updating Topic Question Targets...</h1>
    <div id="log"></div>
    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const updates = {
            // Ortak Konular (32 Soru)
            "Türkiye Cumhuriyeti Anayasası": 6,
            "Atatürk İlkeleri ve İnkılap Tarihi, Ulusal Güvenlik": 2,
            "Devlet Teşkilatı ile İlgili Mevzuat": 9,
            "657 Sayılı Devlet Memurları Kanunu": 6,
            "Türkçe Dil Bilgisi ve Yazışma Kuralları": 2,
            "Halkla İlişkiler": 1,
            "Etik Davranış İlkeleri": 1,
            "Bakanlık Merkez Teşkilatı": 1,
            "Adli ve İdari Yargı Komisyonları ve Yargı Örgütü": 2,
            "UYAP Bilişim Sistemi": 1,
            "5018 Sayılı Kamu Mali Yönetimi": 1,

            // Alan (Görevin Niteliği) Konuları (48 Soru)
            "Bakanlık Teşkilatı": 3,
            "Adli ve İdari Yargı Komisyonlarının Yapısı ve Görevleri": 1,
            "Yargı Örgütü": 4,
            "Elektronik İmza ve SEGBİS": 3,
            "Resmi Yazışma Kuralları": 6,
            "Tebligat Hukuku": 5,
            "Devlet Memurları ile İlgili Diğer Mevzuat": 7,
            "Yazı İşleri Hizmetleri ve Harçlar": 9,
            "5271 Sayılı Ceza Muhakemesi Kanunu (CMK)": 3,
            "6100 Sayılı Hukuk Muhakemeleri Kanunu (HMK)": 3,
            "2577 Sayılı İdari Yargılama Usulü Kanunu": 2,
            "5275 Sayılı İnfaz Kanunu": 2,

            // Subtopics that need specific updates
            "Genel Esaslar": 2,
            "Temel Hak ve Ödevler": 2,
            "Cumhuriyetin Temel Organları": 2,
            "5302 Sayılı İl Özel İdaresi Kanunu": 2,
            "5393 Sayılı Belediye Kanunu": 2,
            "5442 Sayılı İl İdaresi Kanunu": 2,
            "1 Sayılı CB Kararnamesi": 3,
            "657 DMK": 6,
            "5070 Sayılı Kanun": 2,
            "SEGBİS Yönetmelikleri": 1,
            "7201": 3,
            "Elektronik Tebligat": 2,
            "4982": 1,
            "3071": 1,
            "Disiplin Yönetmeliği": 2,
            "Görevde Yükselme Yön.": 1,
            "Atama ve Nakil Yön.": 2,
            "492 Sayılı Harçlar": 1,
            "Adli Yargı Yazı İşleri Yön.": 4,
            "İdari Yargı Yazı İşleri Yön.": 4,
        };

        const logEl = document.getElementById('log');
        const log = (msg) => {
            console.log(msg);
            logEl.innerHTML += `<div>${msg}</div>`;
        };

        async function updateAllTopics() {
            try {
                log("Fetching topics from DB...");
                const snapshot = await getDocs(collection(db, "topics"));
                let updateCount = 0;

                for (const document of snapshot.docs) {
                    const data = document.data();
                    const title = data.title;

                    let targetUpdate = updates[title];
                    if (targetUpdate === undefined) {
                        for (const [key, val] of Object.entries(updates)) {
                            // Check if the DB title includes the key, OR the key includes the DB title
                            // Strip out extra names like "Sayılı" or "Kanunu" for better matching
                            const tClean = title.toLowerCase().replace(/sayılı|kanunu|yönetmeliği/g, '').trim();
                            const kClean = key.toLowerCase().replace(/sayılı|kanunu|yönetmeliği/g, '').trim();

                            if (tClean.includes(kClean) || kClean.includes(tClean)) {
                                targetUpdate = val;
                                break;
                            }
                        }
                    }

                    if (targetUpdate !== undefined) {
                        log(`Updating "${title}" (${document.id}) to target: <b>${targetUpdate}</b>`);
                        await updateDoc(doc(db, "topics", document.id), {
                            totalQuestionTarget: targetUpdate
                        });
                        updateCount++;
                    } else {
                        log(`<span style="color:gray">No update for: "${title}"</span>`);
                    }
                }

                log(`<strong style="color:green">Finished! Updated ${updateCount} topics.</strong>`);

            } catch (error) {
                log(`<strong style="color:red">Error updating topics: ${error.message}</strong>`);
                console.error(error);
            }
        }

        updateAllTopics();
    </script>
</body>

</html>