<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yanlışlarım | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    .mistake-card {
      background: var(--bg-surface);
      border-left: 4px solid var(--color-danger);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s;
    }

    .mistake-card:hover {
      transform: translateX(4px);
    }

    .mistake-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .mistake-text {
      font-weight: 500;
      margin-bottom: 12px;
      color: var(--text-main);
    }

    .btn-retry {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-retry:hover {
      background: var(--color-danger);
      color: white;
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .filter-chip {
      padding: 6px 16px;
      border-radius: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    .filter-chip.active {
      background: var(--color-primary);
      color: var(--text-on-gold);
      border-color: var(--color-primary);
    }
  </style>
    <link rel="manifest" href="/manifest.json">
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <div class="dashboard-container">
    <div class="section-header">
      <div>
        <h2>⚠️ Hata Analizi ve Tekrar</h2>
        <p class="text-muted">Yanlış yaptığınız soruları tekrar çözerek pekiştirin.</p>
      </div>
      <button id="btnSolveAllMistakes" class="btn btn-primary">Tümünü Test Olarak Çöz</button>
    </div>

    <div class="filter-bar" id="categoryFilters">
      <div class="filter-chip active" data-cat="all">Tümü</div>
      <!-- Kategoriler JS ile gelecek -->
    </div>

    <div id="mistakesList">
      <div class="card p-4 text-center">Yükleniyor...</div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { collection, getDocs, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let allMistakes = [];

    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, async (user) => {
        if (user) loadMistakes(user.uid);
      });
    });

    async function loadMistakes(uid) {
      const list = document.getElementById('mistakesList');
      try {
        // Kullanıcının 'wrongs' koleksiyonunu çek (test-engine.js buraya yazmalı)
        // Not: Şu anki test-engine.js sadece exam_results'a yazıyor. 
        // Geliştirme: test-engine.js'i wrongs koleksiyonuna da yazacak şekilde güncelleyeceğiz.
        // Şimdilik demo veri ile yapıyı kuralım.

        // Gerçek veri için: const q = query(collection(db, `users/${uid}/wrongs`), orderBy('date', 'desc'));
        // const snapshot = await getDocs(q);

        // Demo Veri (Sistem boşsa görebilmek için)
        allMistakes = [
          { id: '1', text: 'Anayasa Mahkemesi kaç üyeden oluşur?', category: 'Anayasa', date: new Date() },
          { id: '2', text: 'Memurlara verilen disiplin cezaları nelerdir?', category: 'DMK', date: new Date() }
        ];

        renderMistakes(allMistakes);
        setupFilters();

      } catch (error) {
        console.error(error);
        list.innerHTML = '<div class="text-danger">Veriler alınamadı.</div>';
      }
    }

    function renderMistakes(data) {
      const list = document.getElementById('mistakesList');
      if (data.length === 0) {
        list.innerHTML = '<div class="card p-4 text-center text-muted">Harika! Hiç yanlışınız yok.</div>';
        return;
      }

      list.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'mistake-card';
        div.innerHTML = `
                    <div class="mistake-meta">
                        <span>${item.category}</span>
                        <span>${item.date.toLocaleDateString('tr-TR')}</span>
                    </div>
                    <div class="mistake-text">${item.text}</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Doğru Cevap: <strong>Görüntüle</strong></small>
                        <button class="btn-retry" onclick="alert('Bu özellik test motoruna bağlanacak')">Tekrar Çöz</button>
                    </div>
                `;
        list.appendChild(div);
      });
    }

    function setupFilters() {
      // Kategorileri çıkar ve filtreleri oluştur
      const categories = ['all', ...new Set(allMistakes.map(m => m.category))];
      const container = document.getElementById('categoryFilters');

      container.innerHTML = categories.map(cat =>
        `<div class="filter-chip ${cat === 'all' ? 'active' : ''}" data-cat="${cat}">${cat === 'all' ? 'Tümü' : cat}</div>`
      ).join('');

      container.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          container.querySelector('.active').classList.remove('active');
          chip.classList.add('active');
          const cat = chip.dataset.cat;
          const filtered = cat === 'all' ? allMistakes : allMistakes.filter(m => m.category === cat);
          renderMistakes(filtered);
        });
      });
    }
  </script>
</body>

</html>
