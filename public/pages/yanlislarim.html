<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YanlÄ±ÅŸlarÄ±m | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    body {
      visibility: hidden;
    }

    .mistakes-hero {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }

    .mistakes-hero h2 {
      margin: 0 0 6px;
    }

    .mistakes-hero p {
      margin: 0;
      color: var(--text-muted);
    }

    .mistakes-hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .mistakes-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .mistake-stat-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--shadow-sm);
    }

    .mistake-stat-card strong {
      font-size: 1.6rem;
      display: block;
      margin-top: 4px;
      color: var(--text-primary);
    }

    .mistake-stat-card small {
      color: var(--text-muted);
    }

    .mistakes-filters {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .filter-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .filter-actions {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .category-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow-sm);
    }

    .category-card h4 {
      margin: 0;
      font-size: 1rem;
    }

    .category-meta {
      display: flex;
      justify-content: space-between;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .category-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .mistake-list {
      display: grid;
      gap: 16px;
    }

    .mistake-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--shadow-sm);
    }

    .mistake-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .badge-category {
      background: rgba(212, 175, 55, 0.15);
      color: var(--color-primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .mistake-card p {
      margin: 0 0 12px;
      color: var(--text-primary);
    }

    .mistake-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-state {
      text-align: center;
      padding: 32px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-color);
      color: var(--text-muted);
    }
  </style>
  <link rel="icon" type="image/png" href="../icons/favicon.png">
  <link rel="manifest" href="/manifest.json">
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <div class="dashboard-container">
    <section class="mistakes-hero">
      <div>
        <h2>YanlÄ±ÅŸlarÄ±m</h2>
        <p>YanlÄ±ÅŸ yaptÄ±ÄŸÄ±n sorularÄ± konuya gÃ¶re filtrele, tekrar Ã§Ã¶z ve baÅŸarÄ±ya dÃ¶nÃ¼ÅŸtÃ¼r.</p>
      </div>
      <div class="mistakes-hero-actions">
        <button class="btn btn-primary" id="btnSolveAllExam">ðŸŽ¯ Karma Test (SÄ±nav)</button>
        <button class="btn btn-outline-primary" id="btnSolveAllPractice">ðŸ“– Karma Ã–ÄŸrenme</button>
      </div>
    </section>

    <section class="mistakes-stats">
      <div class="mistake-stat-card">
        <span class="text-muted">Toplam YanlÄ±ÅŸ</span>
        <strong id="totalMistakes">0</strong>
        <small id="totalMistakesHint">Veriler yÃ¼kleniyor</small>
      </div>
      <div class="mistake-stat-card">
        <span class="text-muted">Aktif Konu</span>
        <strong id="totalCategories">0</strong>
        <small>YanlÄ±ÅŸ bulunan konu sayÄ±sÄ±</small>
      </div>
      <div class="mistake-stat-card">
        <span class="text-muted">Son YanlÄ±ÅŸ</span>
        <strong id="lastAttempt">-</strong>
        <small>En son yanlÄ±ÅŸ deneme tarihi</small>
      </div>
    </section>

    <section class="mistakes-filters">
      <div class="filter-group">
        <label for="categorySelect">Konu Filtresi</label>
        <select id="categorySelect">
          <option value="all">TÃ¼mÃ¼</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="searchInput">Sorularda Ara</label>
        <input type="search" id="searchInput" placeholder="Ã–rn: Anayasa, Ceza...">
      </div>
      <div class="filter-group">
        <label for="sortSelect">SÄ±ralama</label>
        <select id="sortSelect">
          <option value="recent">En yeni yanlÄ±ÅŸ</option>
          <option value="oldest">En eski yanlÄ±ÅŸ</option>
          <option value="count">En Ã§ok tekrar</option>
          <option value="category">Konu adÄ±na gÃ¶re</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn btn-secondary" id="btnClearFilters">Filtreleri Temizle</button>
      </div>
    </section>

    <section>
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h3 class="m-0">Konu BazlÄ± Tekrar</h3>
        <small class="text-muted">Konu kartÄ±ndan Ã¶ÄŸrenme veya sÄ±nav modunu baÅŸlatabilirsin.</small>
      </div>
      <div class="category-grid" id="categoryCards"></div>
    </section>

    <section>
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h3 class="m-0">Filtrelenen Sorular</h3>
        <small class="text-muted" id="filteredCount">0 soru</small>
      </div>
      <div class="mistake-list" id="mistakesList">
        <div class="card p-4 text-center">HatalarÄ±nÄ±z analiz ediliyor...</div>
      </div>
    </section>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { showToast } from '../js/notifications.js';
    import { CacheManager } from '../js/cache-manager.js';
    import { collection, getDocs, query, orderBy, deleteDoc, doc, where, documentId, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const state = {
      allMistakes: [],
      filteredMistakes: [],
      selectedCategory: 'all',
      searchTerm: '',
      sort: 'recent',
      lastVisible: null,
      isLoading: false,
      hasMore: true,
      PAGE_SIZE: 20
    };
    const CUSTOM_TEST_LIMIT = 30;

    const ui = {
      totalMistakes: document.getElementById('totalMistakes'),
      totalMistakesHint: document.getElementById('totalMistakesHint'),
      totalCategories: document.getElementById('totalCategories'),
      lastAttempt: document.getElementById('lastAttempt'),
      categorySelect: document.getElementById('categorySelect'),
      searchInput: document.getElementById('searchInput'),
      sortSelect: document.getElementById('sortSelect'),
      categoryCards: document.getElementById('categoryCards'),
      mistakesList: document.getElementById('mistakesList'),
      filteredCount: document.getElementById('filteredCount'),
      btnSolveAllExam: document.getElementById('btnSolveAllExam'),
      btnSolveAllPractice: document.getElementById('btnSolveAllPractice'),
      btnClearFilters: document.getElementById('btnClearFilters')
    };

    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadMistakes(user.uid, true);
        }
      });

      ui.categorySelect.addEventListener('change', (event) => {
        state.selectedCategory = event.target.value;
        applyFilters();
      });

      ui.searchInput.addEventListener('input', (event) => {
        state.searchTerm = event.target.value.trim().toLowerCase();
        applyFilters();
      });

      ui.sortSelect.addEventListener('change', (event) => {
        state.sort = event.target.value;
        applyFilters();
      });

      ui.btnClearFilters.addEventListener('click', () => {
        state.selectedCategory = 'all';
        state.searchTerm = '';
        state.sort = 'recent';
        ui.categorySelect.value = 'all';
        ui.searchInput.value = '';
        ui.sortSelect.value = 'recent';
        applyFilters();
      });

      ui.btnSolveAllExam.addEventListener('click', () => {
        startCustomTest(state.allMistakes.map(m => m.questionId), 'YanlÄ±ÅŸlarÄ±m - Karma Test', 'exam');
      });

      ui.btnSolveAllPractice.addEventListener('click', () => {
        startCustomTest(state.allMistakes.map(m => m.questionId), 'YanlÄ±ÅŸlarÄ±m - Karma Ã–ÄŸrenme', 'practice');
      });

      // Load More Event Delegation
      ui.mistakesList.addEventListener('click', (e) => {
        if (e.target.id === 'btnLoadMore') {
          loadMistakes(auth.currentUser.uid, false);
        }
      });
    });

    async function loadMistakes(uid, isInitial = false) {
      if (state.isLoading || (!state.hasMore && !isInitial)) return;
      state.isLoading = true;

      // Initial cleanup
      if (isInitial) {
        ui.mistakesList.innerHTML = '<div class="card p-4 text-center">HatalarÄ±nÄ±z analiz ediliyor...</div>';
        setSolveButtonsEnabled(false);
        state.allMistakes = [];
        state.lastVisible = null;
        state.hasMore = true;
      } else {
        const existingBtn = document.getElementById('btnLoadMore');
        if (existingBtn) existingBtn.textContent = 'YÃ¼kleniyor...';
      }

      try {
        let q = query(
          collection(db, `users/${uid}/wrongs`),
          orderBy('lastAttempt', 'desc'),
          limit(state.PAGE_SIZE)
        );

        if (state.lastVisible) {
          q = query(q, startAfter(state.lastVisible));
        }

        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          state.hasMore = false;
          updateLoadMoreButton(); // Remove or update
          if (isInitial) renderEmptyState();
          state.isLoading = false;
          return;
        }

        state.lastVisible = snapshot.docs[snapshot.docs.length - 1];

        const rawMistakes = snapshot.docs.map(docSnap => {
          const data = docSnap.data();
          return {
            id: docSnap.id,
            questionId: data.questionId || docSnap.id,
            text: data.text || 'Soru metni yÃ¼klenemedi...',
            category: data.category || 'Genel',
            count: data.count || 1,
            lastAttempt: data.lastAttempt || null
          };
        });

        // Cache Optimized Fetch
        const questionMap = await fetchActiveQuestionsEfficiently(rawMistakes.map(m => m.questionId));

        // Clean stale data (fire and forget delete)
        const staleMistakes = rawMistakes.filter(m => !questionMap.has(m.questionId));
        if (staleMistakes.length > 0) {
          staleMistakes.forEach(m => deleteDoc(doc(db, `users/${uid}/wrongs/${m.id}`)).catch(console.error));
        }

        const activeMistakes = rawMistakes
          .filter(m => questionMap.has(m.questionId))
          .map(m => {
            const question = questionMap.get(m.questionId);
            return {
              ...m,
              text: truncateText(question?.text || m.text),
              category: question?.category || m.category || 'Genel' // Cache'den gÃ¼ncel kategori al
            };
          });

        if (activeMistakes.length === 0 && isInitial) {
          renderEmptyState();
          state.isLoading = false;
          return;
        }

        state.allMistakes = [...state.allMistakes, ...activeMistakes];

        populateCategorySelect();
        renderCategoryCards();
        applyFilters();
        updateSummary();
        setSolveButtonsEnabled(true);
        state.isLoading = false;

      } catch (error) {
        console.error(error);
        if (isInitial) {
          ui.mistakesList.innerHTML = '<div class="text-danger">Veriler alÄ±namadÄ±.</div>';
          setSolveButtonsEnabled(false);
        }
        state.isLoading = false;
      }
    }

    // Cache Optimized Fetch Helper
    async function fetchActiveQuestionsEfficiently(ids) {
      const questionMap = new Map();
      const missingIds = [];

      for (const id of ids) {
        const cachedQ = await CacheManager.getQuestion(id);
        if (cachedQ) {
          questionMap.set(id, cachedQ);
        } else {
          missingIds.push(id);
        }
      }

      if (missingIds.length > 0) {
        const remoteMap = await fetchActiveQuestionsMap(missingIds);
        remoteMap.forEach((val, key) => {
          questionMap.set(key, val);
          CacheManager.saveQuestion(val);
        });
      }
      return questionMap;
    }

    function renderEmptyState() {
      ui.totalMistakes.textContent = '0';
      ui.totalMistakesHint.textContent = 'Harika! Åžu an yanlÄ±ÅŸÄ±n yok.';
      ui.totalCategories.textContent = '0';
      ui.lastAttempt.textContent = '-';
      ui.categoryCards.innerHTML = '<div class="empty-state">HiÃ§ yanlÄ±ÅŸ soru bulunamadÄ±.</div>';
      ui.mistakesList.innerHTML = '<div class="empty-state">YanlÄ±ÅŸ yaptÄ±ÄŸÄ±n soru yok, bÃ¶yle devam! ðŸŽ‰</div>';
      ui.filteredCount.textContent = '0 soru';
      setSolveButtonsEnabled(false);
    }

    function populateCategorySelect() {
      const current = ui.categorySelect.value;
      const categories = ['all', ...new Set(state.allMistakes.map(m => m.category))];
      ui.categorySelect.innerHTML = categories.map(cat => {
        return `<option value="${cat}">${cat === 'all' ? 'TÃ¼mÃ¼' : cat}</option>`;
      }).join('');
      ui.categorySelect.value = current;
    }

    function updateSummary() {
      const questionCount = state.allMistakes.length;
      const totalWrongCount = state.allMistakes.reduce((sum, item) => sum + (item.count || 0), 0);
      const categoryCount = new Set(state.allMistakes.map(m => m.category)).size;
      const latest = state.allMistakes.reduce((latestDate, item) => {
        if (!latestDate) return item.lastAttempt || null;
        return compareDate(item.lastAttempt, latestDate) > 0 ? item.lastAttempt : latestDate;
      }, null);

      ui.totalMistakes.textContent = totalWrongCount;
      ui.totalMistakesHint.textContent = questionCount > 0 ? `${questionCount} soruda tekrar fÄ±rsatÄ±n var.` : 'Harika! Åžu an yanlÄ±ÅŸÄ±n yok.';
      ui.totalCategories.textContent = categoryCount;
      ui.lastAttempt.textContent = latest ? formatDate(latest) : '-';
    }

    function renderCategoryCards() {
      // Only re-render if we are in 'all' category mode to avoid confusing jumps while filtering
      if (ui.categorySelect.value !== 'all') return;

      if (state.allMistakes.length === 0) {
        ui.categoryCards.innerHTML = '<div class="empty-state">Konu kartÄ± oluÅŸturulacak veri bulunamadÄ±.</div>';
        return;
      }

      const categoryMap = new Map();
      state.allMistakes.forEach(item => {
        const entry = categoryMap.get(item.category) || { total: 0, lastAttempt: null, ids: [] };
        entry.total += 1;
        entry.ids.push(item.questionId);
        if (!entry.lastAttempt || compareDate(item.lastAttempt, entry.lastAttempt) > 0) {
          entry.lastAttempt = item.lastAttempt;
        }
        categoryMap.set(item.category, entry);
      });

      ui.categoryCards.innerHTML = Array.from(categoryMap.entries()).map(([category, data]) => {
        return `
          <div class="category-card">
            <div>
              <h4>${category}</h4>
              <div class="category-meta">
                <span>${data.total} soru</span>
                <span>${data.lastAttempt ? formatDate(data.lastAttempt) : '-'}</span>
              </div>
            </div>
            <div class="category-actions">
              <button class="btn btn-outline-primary" data-category="${category}" data-mode="practice">ðŸ“– Ã–ÄŸrenme</button>
              <button class="btn btn-primary" data-category="${category}" data-mode="exam">ðŸŽ¯ SÄ±nav</button>
            </div>
          </div>
        `;
      }).join('');

      ui.categoryCards.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const category = btn.dataset.category;
          const mode = btn.dataset.mode;
          const ids = state.allMistakes.filter(m => m.category === category).map(m => m.questionId);
          startCustomTest(ids, `${category} - YanlÄ±ÅŸlarÄ±m`, mode);
        });
      });
    }

    function applyFilters() {
      let data = [...state.allMistakes];

      if (state.selectedCategory !== 'all') {
        data = data.filter(item => item.category === state.selectedCategory);
      }

      if (state.searchTerm) {
        data = data.filter(item => {
          return item.text.toLowerCase().includes(state.searchTerm) || item.category.toLowerCase().includes(state.searchTerm);
        });
      }

      if (state.sort === 'recent') {
        data.sort((a, b) => compareDate(b.lastAttempt, a.lastAttempt));
      } else if (state.sort === 'oldest') {
        data.sort((a, b) => compareDate(a.lastAttempt, b.lastAttempt));
      } else if (state.sort === 'count') {
        data.sort((a, b) => (b.count || 0) - (a.count || 0));
      } else if (state.sort === 'category') {
        data.sort((a, b) => a.category.localeCompare(b.category));
      }

      state.filteredMistakes = data;
      renderMistakeList();
    }

    function renderMistakeList() {
      const data = state.filteredMistakes;
      ui.filteredCount.textContent = `${data.length} soru`;

      if (data.length === 0) {
        ui.mistakesList.innerHTML = '<div class="empty-state">Bu filtrelerle eÅŸleÅŸen yanlÄ±ÅŸ bulunamadÄ±.</div>';
        return;
      }

      const listHtml = data.map(item => {
        return `
          <div class="mistake-card" id="mistake-${item.questionId}">
            <div class="mistake-card-header">
              <span class="badge-category">${item.category}</span>
              <span>${formatDate(item.lastAttempt)}</span>
            </div>
            <p>${item.text}</p>
            <div class="mistake-card-footer">
              <span>YanlÄ±ÅŸ sayÄ±sÄ±: ${item.count}</span>
              <button class="btn btn-outline-primary" data-question="${item.questionId}">Tekrar Ã‡Ã¶z</button>
            </div>
          </div>
        `;
      }).join('');

      ui.mistakesList.innerHTML = listHtml;

      updateLoadMoreButton();

      // Re-attach listeners for dynamically created buttons
      ui.mistakesList.querySelectorAll('button[data-question]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Bubbling'i durdur ki load more'a gitmesin
          const id = btn.dataset.question;
          startCustomTest([id], 'YanlÄ±ÅŸlarÄ±m - Tekrar Sorusu', 'practice');
        });
      });
    }

    function updateLoadMoreButton() {
      // Remove existing button if any inside the list container (not strictly necessary with innerHTML reset but good practice)
      // Actually we append it to the list container.

      const isFiltering = state.selectedCategory !== 'all' || state.searchTerm.length > 0;

      if (state.hasMore && !isFiltering) {
        const btnDiv = document.createElement('div');
        btnDiv.className = 'text-center mt-3';
        btnDiv.innerHTML = `<button id="btnLoadMore" class="btn btn-outline-secondary" style="width: 200px;">Daha Fazla YÃ¼kle</button>`;
        ui.mistakesList.appendChild(btnDiv);
      }
    }

    function startCustomTest(ids, title, mode) {
      const filteredIds = ids.filter(Boolean);
      if (filteredIds.length === 0) {
        showToast('Ã‡Ã¶zÃ¼lecek yanlÄ±ÅŸ soru bulunamadÄ±.', 'warning');
        return;
      }

      const finalIds = filteredIds.slice(0, CUSTOM_TEST_LIMIT);
      if (filteredIds.length > CUSTOM_TEST_LIMIT) {
        showToast(`Test ${CUSTOM_TEST_LIMIT} soru ile sÄ±nÄ±rlandÄ±.`, 'info');
      }
      localStorage.setItem('customTestQuestionIds', JSON.stringify(finalIds));
      localStorage.setItem('customTestTitle', title);
      localStorage.removeItem('customTestQuestions');
      window.location.href = `/test?mode=custom&source=local&testMode=${mode}&limit=${CUSTOM_TEST_LIMIT}&return=${encodeURIComponent('/yanlislarim')}`;
    }

    function setSolveButtonsEnabled(isEnabled) {
      [ui.btnSolveAllExam, ui.btnSolveAllPractice].forEach(btn => {
        if (!btn) return;
        btn.disabled = !isEnabled;
        btn.classList.toggle('disabled', !isEnabled);
      });
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
      return date.toLocaleDateString('tr-TR');
    }

    function compareDate(a, b) {
      if (!a && !b) return 0;
      if (!a) return -1;
      if (!b) return 1;
      const dateA = a.seconds ? a.seconds * 1000 : new Date(a).getTime();
      const dateB = b.seconds ? b.seconds * 1000 : new Date(b).getTime();
      return dateA - dateB;
    }

    function truncateText(text) {
      if (!text) return 'Soru metni yÃ¼klenemedi...';
      return text.length > 150 ? `${text.substring(0, 150)}...` : text;
    }

    async function fetchActiveQuestionsMap(ids) {
      const activeQuestions = new Map();
      const uniqueIds = Array.from(new Set(ids.filter(Boolean)));
      if (uniqueIds.length === 0) return activeQuestions;

      for (let i = 0; i < uniqueIds.length; i += 10) {
        const chunk = uniqueIds.slice(i, i + 10);
        const q = query(collection(db, "questions"), where(documentId(), "in", chunk));
        const snap = await getDocs(q);
        snap.docs.forEach(docSnap => {
          const data = docSnap.data();
          if (data?.isDeleted || data?.isActive === false) return;
          activeQuestions.set(docSnap.id, { id: docSnap.id, ...data });
        });
      }

      return activeQuestions;
    }
  </script>
</body>

</html>