<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deneme SÄ±navlarÄ± | GOLD GYS</title>
    <link rel="stylesheet" href="../styles/tokens.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        body {
            visibility: hidden;
        }

        .denemeler-page {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .deneme-hero {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.18), rgba(15, 23, 42, 0.9));
            border-radius: var(--radius-lg);
            padding: 32px;
            color: var(--text-on-gold);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 28px;
            box-shadow: var(--shadow-lg);
        }

        .deneme-hero h1 {
            font-size: 2rem;
            margin-bottom: 12px;
            font-family: var(--font-family-serif);
        }

        .deneme-hero p {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .hero-panel {
            background: rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: grid;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hero-panel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #f8fafc;
        }

        .hero-panel-item .label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .hero-panel-item .value {
            font-size: 1.4rem;
            font-weight: 800;
        }

        .info-section {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .section-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 1.3rem;
            margin-bottom: 6px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .info-card {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            background: var(--bg-hover);
        }

        .info-card h3 {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .info-card p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .pill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pill {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .exam-list-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-field input,
        .filter-field select {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
            color: var(--text-main);
        }

        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .exam-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            box-shadow: var(--shadow-sm);
        }

        .exam-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .exam-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .exam-card-actions {
            margin-top: auto;
        }

        .exam-highlight {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .empty-state {
            padding: 32px;
            text-align: center;
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-muted);
        }

        .skeleton {
            height: 160px;
            border-radius: 16px;
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.2) 25%, rgba(148, 163, 184, 0.35) 37%, rgba(148, 163, 184, 0.2) 63%);
            background-size: 400% 100%;
            animation: shimmer 1.4s ease infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 100% 0;
            }
            100% {
                background-position: -100% 0;
            }
        }

        @media (max-width: 768px) {
            .deneme-hero {
                padding: 24px;
            }

            .hero-panel {
                order: -1;
            }
        }
    </style>
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <script type="module">
        import { initLayout } from '../js/ui-loader.js';
        import { db } from "../js/firebase-config.js";
        import { collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const state = {
            exams: []
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return "-";
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleDateString('tr-TR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        };

        const formatNumber = (value) => new Intl.NumberFormat('tr-TR').format(value);

        const renderStats = (exams) => {
            const totalExams = exams.length;
            const totalQuestions = exams.reduce((sum, exam) => sum + (exam.totalQuestions || 0), 0);
            const avgDuration = totalExams ? Math.round(exams.reduce((sum, exam) => sum + (exam.duration || 0), 0) / totalExams) : 0;
            const latestExam = exams[0];

            document.getElementById('statExamCount').textContent = totalExams;
            document.getElementById('statQuestionCount').textContent = formatNumber(totalQuestions || 0);
            document.getElementById('statAvgDuration').textContent = avgDuration ? `${avgDuration} dk` : "-";
            document.getElementById('statLastUpdate').textContent = latestExam ? formatDate(latestExam.createdAt) : "-";
        };

        const updateRoleFilter = (exams) => {
            const roleFilter = document.getElementById('roleFilter');
            const roles = [...new Set(exams.map((exam) => exam.role).filter(Boolean))];
            roleFilter.innerHTML = '<option value="all">TÃ¼mÃ¼</option>' + roles.map((role) => `<option value="${role}">${role}</option>`).join('');
        };

        const renderExams = (exams) => {
            const grid = document.getElementById('examsGrid');
            const countNote = document.getElementById('examCountNote');

            grid.innerHTML = '';

            if (!exams.length) {
                countNote.textContent = "0 deneme gÃ¶steriliyor";
                grid.innerHTML = `
                    <div class="empty-state">
                        HenÃ¼z eÅŸleÅŸen bir deneme bulunamadÄ±. Filtreleri temizleyip tekrar deneyin.
                    </div>
                `;
                return;
            }

            countNote.textContent = `${exams.length} deneme gÃ¶steriliyor`;

            exams.forEach((exam, index) => {
                const card = document.createElement('div');
                card.className = `exam-card ${index === 0 ? 'exam-highlight' : ''}`;
                card.innerHTML = `
                    <div class="exam-card-header">
                        <span class="badge bg-light text-dark">${exam.role || 'Genel'}</span>
                        <span class="small text-muted">${formatDate(exam.createdAt)}</span>
                    </div>
                    <div>
                        <h3>${exam.title}</h3>
                        <p class="text-muted small">${exam.description || 'Mevzuat daÄŸÄ±lÄ±mÄ±na uygun, otomatik seÃ§ilmiÅŸ sorularla hazÄ±rlandÄ±.'}</p>
                    </div>
                    <div class="exam-meta">
                        <span>ğŸ§© ${exam.totalQuestions || 0} Soru</span>
                        <span>â±ï¸ ${exam.duration || 0} dk</span>
                        <span>ğŸ¯ Puan: %0-100</span>
                    </div>
                    <div class="exam-card-actions">
                        <a href="deneme.html?id=${exam.id}" class="btn btn-outline-primary w-100">SÄ±nava BaÅŸla</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        const applyFilters = () => {
            const searchValue = document.getElementById('examSearch').value.toLowerCase().trim();
            const roleValue = document.getElementById('roleFilter').value;

            const filtered = state.exams.filter((exam) => {
                const matchesSearch = !searchValue || exam.title?.toLowerCase().includes(searchValue);
                const matchesRole = roleValue === 'all' || exam.role === roleValue;
                return matchesSearch && matchesRole;
            });

            renderExams(filtered);
        };

        const showEmptyExamsState = () => {
            const grid = document.getElementById('examsGrid');
            const countNote = document.getElementById('examCountNote');

            countNote.textContent = "0 deneme gÃ¶steriliyor";
            grid.innerHTML = `
                <div class="empty-state">
                    Åu anda yayÄ±nlanmÄ±ÅŸ deneme sÄ±navÄ± bulunmuyor. Admin panelinde deneme yayÄ±nlandÄ±ÄŸÄ±nda burada listelenecek.
                </div>
            `;
        };

        const loadExams = async () => {
            const grid = document.getElementById('examsGrid');
            grid.innerHTML = `
                <div class="skeleton"></div>
                <div class="skeleton"></div>
                <div class="skeleton"></div>
            `;

            try {
                const q = query(
                    collection(db, "exams"),
                    where("isActive", "==", true),
                    orderBy("createdAt", "desc")
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    state.exams = [];
                    renderStats(state.exams);
                    updateRoleFilter(state.exams);
                    showEmptyExamsState();
                    return;
                }

                state.exams = snapshot.docs.map((docSnap) => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));

                renderStats(state.exams);
                updateRoleFilter(state.exams);
                renderExams(state.exams);
            } catch (error) {
                console.error("Hata:", error);
                grid.innerHTML = `<div class="empty-state">BaÄŸlantÄ± hatasÄ±: ${error.message}</div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await initLayout();
            await loadExams();

            document.getElementById('examSearch').addEventListener('input', applyFilters);
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
        });
    </script>

    <div class="dashboard-container denemeler-page">
        <section class="deneme-hero">
            <div>
                <span class="badge bg-purple-subtle text-dark">Otomatik Deneme Sistemi</span>
                <h1>Deneme SÄ±navlarÄ±</h1>
                <p>Denemeler, aktif soru havuzundan mevzuat ÅŸablonuna gÃ¶re seÃ§ilir. Sistem 75 soruluk daÄŸÄ±lÄ±mÄ± tamamlar,
                    kalan 5 soruyu da rastgele ekleyerek 80 soruluk gerÃ§ek sÄ±nav formatÄ±nÄ± oluÅŸturur.</p>
                <div class="hero-actions">
                    <a href="#examListSection" class="btn btn-dark">Denemeleri GÃ¶r</a>
                    <a href="/pages/testler.html" class="btn btn-light">Konu BazlÄ± Teste GeÃ§</a>
                </div>
            </div>
            <div class="hero-panel">
                <div class="hero-panel-item">
                    <span class="label">YayÄ±nlanan Deneme</span>
                    <span class="value" id="statExamCount">0</span>
                </div>
                <div class="hero-panel-item">
                    <span class="label">Toplam Soru</span>
                    <span class="value" id="statQuestionCount">0</span>
                </div>
                <div class="hero-panel-item">
                    <span class="label">Ortalama SÃ¼re</span>
                    <span class="value" id="statAvgDuration">-</span>
                </div>
                <div class="hero-panel-item">
                    <span class="label">Son GÃ¼ncelleme</span>
                    <span class="value" id="statLastUpdate">-</span>
                </div>
            </div>
        </section>

        <section class="info-section">
            <div class="section-header">
                <div>
                    <h2>Deneme Sistemi NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h2>
                    <p class="text-muted">Admin panelindeki otomatik deneme Ã¼reticisinin adÄ±mlarÄ±nÄ± Ã¶zetledik.</p>
                </div>
            </div>
            <div class="info-grid">
                <div class="info-card">
                    <h3>1) Aktif Havuz TaramasÄ±</h3>
                    <p>YayÄ±n durumundaki tÃ¼m sorular sistem tarafÄ±ndan Ã§ekilir ve mevzuat kodlarÄ±na gÃ¶re gruplanÄ±r.</p>
                </div>
                <div class="info-card">
                    <h3>2) Åablon DaÄŸÄ±lÄ±mÄ±</h3>
                    <p>Her kanun iÃ§in belirlenen soru sayÄ±sÄ± rastgele seÃ§ilir. Eksik kalan konular raporlanÄ±r.</p>
                </div>
                <div class="info-card">
                    <h3>3) 80 Soruya Tamamlama</h3>
                    <p>Åablondan gelen 75 soru tamamlandÄ±ktan sonra sistem kalan 5 soruyu havuzdan dengeli biÃ§imde ekler.</p>
                </div>
                <div class="info-card">
                    <h3>4) Snapshot ve YayÄ±n</h3>
                    <p>SeÃ§ilen sorular sÄ±nava kilitlenir ve yayÄ±nlanÄ±r. BÃ¶ylece sÄ±nav boyunca soru seti sabit kalÄ±r.</p>
                </div>
            </div>
        </section>

        <section class="info-section">
            <div class="section-header">
                <div>
                    <h2>Deneme FormatÄ±</h2>
                    <p class="text-muted">SÄ±nav deneyimini Ã¶nceden bilin, stratejinizi planlayÄ±n.</p>
                </div>
            </div>
            <div class="pill-list">
                <span class="pill">80 Soru / Otomatik Åablon</span>
                <span class="pill">SÃ¼re: Ortalama 100 dk</span>
                <span class="pill">Puanlama: DoÄŸru / Toplam</span>
                <span class="pill">SÄ±nav bitince Ã§Ã¶zÃ¼mler aÃ§Ä±lÄ±r</span>
                <span class="pill">SonuÃ§lar analiz ekranÄ±na kaydedilir</span>
            </div>
        </section>

        <section id="examListSection" class="exam-list-section">
            <div class="section-header">
                <div>
                    <h2>YayÄ±nlanan Denemeler</h2>
                    <p class="text-muted">Seviyene uygun denemeyi seÃ§, gerÃ§ek sÄ±nav temposunu yakala.</p>
                </div>
                <div class="filter-bar">
                    <div class="filter-field">
                        <label for="examSearch" class="text-muted small">BaÅŸlÄ±kta ara</label>
                        <input id="examSearch" type="search" placeholder="Ã–rn: 2025 Genel Deneme">
                    </div>
                    <div class="filter-field">
                        <label for="roleFilter" class="text-muted small">Ãœnvan</label>
                        <select id="roleFilter">
                            <option value="all">TÃ¼mÃ¼</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="examCountNote" class="text-muted small"></div>
            <div id="examsGrid" class="exam-grid"></div>
        </section>
    </div>
</body>

</html>
