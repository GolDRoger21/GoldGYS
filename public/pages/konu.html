<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konu Detayƒ± | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    /* --- PREMIUM KONU DETAY STƒ∞LLERƒ∞ --- */

    /* Hero Section */
    .topic-hero {
      background: linear-gradient(135deg, var(--bg-surface), var(--bg-body));
      padding: 40px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .topic-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--color-primary);
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-full);
      background: var(--bg-hover);
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .back-btn:hover {
      background: var(--bg-surface);
      color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    .topic-title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 10px;
      font-family: var(--font-family-serif);
    }

    .topic-desc {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 800px;
      line-height: 1.6;
    }

    /* Kategori Ba≈ülƒ±klarƒ± */
    .category-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 40px 0 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .cat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(212, 175, 55, 0.1);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .cat-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
    }

    /* ƒ∞√ßerik Gridleri */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .pdf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .note-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Video Kartƒ± */
    .video-card {
      background: var(--bg-surface);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .video-card:hover {
      transform: translateY(-4px);
      border-color: var(--color-primary);
    }

    .video-thumb {
      position: relative;
      padding-bottom: 56.25%;
      background: #000;
    }

    .video-thumb img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.8;
    }

    .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      border: 2px solid white;
    }

    .video-info {
      padding: 15px;
    }

    .video-title {
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 5px;
      display: block;
    }

    .video-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* PDF Kartƒ± */
    .pdf-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      text-decoration: none;
      transition: all 0.2s;
    }

    .pdf-card:hover {
      background: var(--bg-hover);
      border-color: var(--color-primary);
    }

    .pdf-icon {
      font-size: 2rem;
      color: #e74c3c;
    }

    .pdf-info h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 4px 0;
    }

    .pdf-info span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Not Kartƒ± */
    .note-card {
      background: var(--bg-surface);
      border-left: 4px solid var(--color-success);
      padding: 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .note-card:hover {
      background: var(--bg-hover);
    }

    .note-title {
      font-weight: 600;
      color: var(--text-main);
      font-size: 1.1rem;
    }

    /* Video Modal */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .video-wrapper {
      width: 90%;
      max-width: 900px;
      aspect-ratio: 16/9;
      position: relative;
    }

    .video-wrapper iframe {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }

    .close-video {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    /* Not G√∂r√ºnt√ºleyici */
    .note-viewer {
      position: fixed;
      top: 0;
      right: -100%;
      width: 600px;
      height: 100%;
      background: var(--bg-surface);
      z-index: 2000;
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
      transition: right 0.3s ease;
      padding: 40px;
      overflow-y: auto;
    }

    .note-viewer.active {
      right: 0;
    }

    .close-note {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .note-body {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-main);
    }

    .note-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
    }

    .note-overlay.active {
      display: block;
    }

    @media (max-width: 768px) {
      .note-viewer {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <div class="dashboard-container">
    <!-- Hero -->
    <div class="topic-hero">
      <a href="/pages/konular.html" class="back-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        T√ºm Konulara D√∂n
      </a>
      <h1 class="topic-title" id="topicTitle">Y√ºkleniyor...</h1>
      <p class="topic-desc" id="topicDesc">...</p>
    </div>

    <!-- 1. Vƒ∞DEO DERSLER -->
    <div id="sectionVideos" style="display:none;">
      <div class="category-header">
        <div class="cat-icon">üé•</div>
        <h2 class="cat-title">Video Dersler</h2>
      </div>
      <div id="videoList" class="video-grid"></div>
    </div>

    <!-- 2. DERS NOTLARI (PDF) -->
    <div id="sectionPDFs" style="display:none;">
      <div class="category-header">
        <div class="cat-icon">üìï</div>
        <h2 class="cat-title">Ders Notlarƒ± (PDF)</h2>
      </div>
      <div id="pdfList" class="pdf-grid"></div>
    </div>

    <!-- 3. √ñZET NOTLAR (HTML) -->
    <div id="sectionNotes" style="display:none;">
      <div class="category-header">
        <div class="cat-icon">üìù</div>
        <h2 class="cat-title">√ñzet Bilgiler</h2>
      </div>
      <div id="noteList" class="note-grid"></div>
    </div>

    <!-- 4. TESTLER -->
    <div id="sectionTests" style="display:none;">
      <div class="category-header">
        <div class="cat-icon">üß†</div>
        <h2 class="cat-title">Konu Testleri</h2>
      </div>
      <div id="testList" class="video-grid"></div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="video-modal">
    <div class="video-wrapper">
      <span class="close-video" onclick="closeVideo()">√ó</span>
      <div id="videoPlayer"></div>
    </div>
  </div>

  <!-- Not G√∂r√ºnt√ºleyici -->
  <div class="note-overlay" id="noteOverlay" onclick="closeNote()"></div>
  <div class="note-viewer" id="noteViewer">
    <span class="close-note" onclick="closeNote()">√ó</span>
    <h2 id="noteTitleDisplay" class="mb-4"></h2>
    <div id="noteBodyDisplay" class="note-body"></div>
  </div>

  <script type="module">
    import { db } from '../js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const topicId = urlParams.get('id');

      if (!topicId) {
        window.location.href = '/pages/konular.html';
        return;
      }

      await loadTopicContent(topicId);
    });

    async function loadTopicContent(topicId) {
      try {
        // 1. Konu Bilgisi
        const topicSnap = await getDoc(doc(db, "topics", topicId));
        if (!topicSnap.exists()) return alert("Konu bulunamadƒ±.");

        const data = topicSnap.data();
        document.getElementById('topicTitle').innerText = data.title;
        document.getElementById('topicDesc').innerText = data.description || 'Bu konu i√ßin a√ßƒ±klama bulunmuyor.';
        document.title = `${data.title} | GOLD GYS`;

        // 2. Dersleri √áek ve Kategorize Et
        const q = query(collection(db, `topics/${topicId}/lessons`), orderBy("order", "asc"));
        const snapshot = await getDocs(q);

        const videos = [];
        const pdfs = [];
        const notes = [];

        snapshot.forEach(doc => {
          const lesson = doc.data();
          if (lesson.materials) {
            lesson.materials.forEach(mat => {
              if (mat.type === 'video') videos.push(mat);
              else if (mat.type === 'pdf') pdfs.push(mat);
              else if (mat.type === 'html') notes.push(mat);
            });
          }
        });

        // Render
        renderVideos(videos);
        renderPDFs(pdfs);
        renderNotes(notes);
        renderTests(topicId); // Testleri de g√∂ster

      } catch (error) {
        console.error("Hata:", error);
      }
    }

    function renderVideos(list) {
      if (list.length === 0) return;
      document.getElementById('sectionVideos').style.display = 'block';
      const container = document.getElementById('videoList');

      list.forEach(video => {
        // YouTube ID ve Thumbnail
        let videoId = '';
        try {
          if (video.url.includes('youtu')) {
            const urlObj = new URL(video.url.startsWith('http') ? video.url : `https://${video.url}`);
            if (video.url.includes('watch')) videoId = urlObj.searchParams.get('v');
            else if (video.url.includes('embed')) videoId = urlObj.pathname.split('/').pop();
            else if (video.url.includes('youtu.be')) videoId = urlObj.pathname.substring(1);
          }
        } catch (e) { }

        const thumbUrl = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '../img/video-placeholder.jpg';

        const div = document.createElement('div');
        div.className = 'video-card';
        div.onclick = () => openVideo(videoId);
        div.innerHTML = `
                    <div class="video-thumb">
                        <img src="${thumbUrl}" alt="${video.title}" loading="lazy">
                        <div class="play-icon">‚ñ∂</div>
                    </div>
                    <div class="video-info">
                        <span class="video-title">${video.title}</span>
                        <span class="video-meta">Video Ders</span>
                    </div>
                `;
        container.appendChild(div);
      });
    }

    function renderPDFs(list) {
      if (list.length === 0) return;
      document.getElementById('sectionPDFs').style.display = 'block';
      const container = document.getElementById('pdfList');

      list.forEach(pdf => {
        const a = document.createElement('a');
        a.href = pdf.url;
        a.target = '_blank';
        a.className = 'pdf-card';
        a.innerHTML = `
                    <div class="pdf-icon">üìï</div>
                    <div class="pdf-info">
                        <h4>${pdf.title}</h4>
                        <span>G√∂r√ºnt√ºle / ƒ∞ndir</span>
                    </div>
                `;
        container.appendChild(a);
      });
    }

    function renderNotes(list) {
      if (list.length === 0) return;
      document.getElementById('sectionNotes').style.display = 'block';
      const container = document.getElementById('noteList');

      list.forEach(note => {
        const div = document.createElement('div');
        div.className = 'note-card';
        div.onclick = () => openNote(note.title, note.url); // note.url i√ßinde HTML var
        div.innerHTML = `
                    <span class="note-title">${note.title}</span>
                    <span class="text-muted">Oku ‚Üí</span>
                `;
        container.appendChild(div);
      });
    }

    function renderTests(topicId) {
      // ≈ûimdilik demo testler
      document.getElementById('sectionTests').style.display = 'block';
      const container = document.getElementById('testList');

      container.innerHTML = `
                <div class="video-card" onclick="window.location.href='/pages/test.html?topic=${topicId}&mode=quick'">
                    <div class="video-info" style="border-left:4px solid #10b981;">
                        <span class="video-title">‚ö° Hƒ±zlƒ± Tarama Testi</span>
                        <span class="video-meta">20 Soru ‚Ä¢ Rastgele</span>
                    </div>
                </div>
                <div class="video-card" onclick="window.location.href='/pages/test.html?topic=${topicId}&mode=full'">
                    <div class="video-info" style="border-left:4px solid #3b82f6;">
                        <span class="video-title">üìù Kapsamlƒ± Konu Testi</span>
                        <span class="video-meta">50 Soru ‚Ä¢ T√ºm Konu</span>
                    </div>
                </div>
            `;
    }

    // --- GLOBAL FONKSƒ∞YONLAR ---
    window.openVideo = (videoId) => {
      if (!videoId) return alert("Video a√ßƒ±lamadƒ±.");
      const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      document.getElementById('videoPlayer').innerHTML = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
      document.getElementById('videoModal').style.display = 'flex';
    };

    window.closeVideo = () => {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoPlayer').innerHTML = '';
    };

    window.openNote = (title, content) => {
      document.getElementById('noteTitleDisplay').innerText = title;
      document.getElementById('noteBodyDisplay').innerHTML = content;
      document.getElementById('noteViewer').classList.add('active');
      document.getElementById('noteOverlay').classList.add('active');
    };

    window.closeNote = () => {
      document.getElementById('noteViewer').classList.remove('active');
      document.getElementById('noteOverlay').classList.remove('active');
    };
  </script>
</body>

</html>