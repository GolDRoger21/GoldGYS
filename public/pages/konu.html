<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konu Detayƒ± | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    /* --- PREMIUM HEADER TASARIMI --- */
    .topic-header-modern {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 0;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .back-link-modern {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      text-decoration: none;
      transition: color 0.2s;
    }

    .back-link-modern:hover {
      color: var(--color-primary);
    }

    .topic-title-modern {
      font-family: var(--font-family-serif);
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
      line-height: 1.2;
    }

    /* ƒ∞statistik Kartlarƒ± (Mini) */
    .stats-mini-grid {
      display: flex;
      gap: 15px;
    }

    .stat-pill {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      padding: 8px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-main);
      box-shadow: var(--shadow-sm);
    }

    .stat-pill-icon {
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    .stat-pill strong {
      font-weight: 700;
      margin-left: 4px;
    }

    /* ƒ∞lerleme Alanƒ± */
    .progress-card {
      background: linear-gradient(135deg, var(--bg-surface), var(--bg-hover));
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .progress-circle {
      width: 60px;
      height: 60px;
      position: relative;
      flex-shrink: 0;
    }

    .progress-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .progress-circle circle {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
    }

    .prog-bg {
      stroke: var(--border-color);
    }

    .prog-val {
      stroke: var(--color-success);
      stroke-dasharray: 150;
      stroke-dashoffset: 150;
      transition: stroke-dashoffset 1s ease;
    }

    .prog-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--text-main);
    }

    .progress-info h4 {
      margin: 0 0 4px 0;
      font-size: 1rem;
      color: var(--text-main);
    }

    .progress-info p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Kategori Grid (Rafine Edilmi≈ü) */
    .hub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .hub-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 160px;
    }

    .hub-card:hover {
      transform: translateY(-4px);
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
    }

    .card-icon-bg {
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 5rem;
      opacity: 0.05;
      color: var(--text-main);
      pointer-events: none;
    }

    .card-icon-main {
      font-size: 2rem;
      margin-bottom: 15px;
      display: inline-block;
      background: var(--bg-hover);
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .card-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Viewer Overlay (Aynƒ± Kalabilir) */
    .viewer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-body);
      z-index: 2000;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.2s ease;
    }

    .viewer-overlay.active {
      display: flex;
    }

    .viewer-header {
      padding: 15px 30px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-surface);
    }

    .viewer-body {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }

    /* Liste Elemanlarƒ± */
    .content-list-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .content-list-item:hover {
      border-color: var(--color-primary);
      background: var(--bg-hover);
    }

    @media (max-width: 768px) {
      .topic-header-modern {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }

      .stats-mini-grid {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 5px;
      }

      .stat-pill {
        flex-shrink: 0;
      }
    }
  </style>
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <div class="dashboard-container">

    <!-- Modern Header -->
    <div class="topic-header-modern">
      <div class="header-left">
        <a href="/pages/konular.html" class="back-link-modern">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          Konulara D√∂n
        </a>
        <h1 class="topic-title-modern" id="topicTitle">Y√ºkleniyor...</h1>
      </div>

      <!-- ƒ∞statistik Haplarƒ± -->
      <div class="stats-mini-grid">
        <div class="stat-pill">
          <span class="stat-pill-icon">‚öñÔ∏è</span>
          <span>Sƒ±navda: <strong id="examQCount">-</strong> Soru</span>
        </div>
        <div class="stat-pill">
          <span class="stat-pill-icon">üìö</span>
          <span>Sistemde: <strong id="totalQCount">-</strong> Soru</span>
        </div>
        <div class="stat-pill">
          <span class="stat-pill-icon">‚úÖ</span>
          <span>√á√∂z√ºlen: <strong id="solvedQCount">0</strong></span>
        </div>
      </div>
    </div>

    <!-- ƒ∞lerleme Kartƒ± -->
    <div class="progress-card">
      <div class="progress-circle">
        <svg viewBox="0 0 36 36">
          <path class="prog-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="prog-val" id="progressRing" stroke-dasharray="0, 100"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        </svg>
        <div class="prog-text" id="progressText">0%</div>
      </div>
      <div class="progress-info">
        <h4>Konu Tamamlama Durumu</h4>
        <p>Dersleri izleyip notlarƒ± okuyarak ilerlemenizi artƒ±rƒ±n.</p>
      </div>
    </div>

    <!-- ƒ∞√ßerik Grid (Hub) -->
    <div class="hub-grid">
      <div class="hub-card" onclick="openViewer('video')">
        <div class="card-icon-bg">üé•</div>
        <div class="card-icon-main">üé•</div>
        <div>
          <div class="card-title">Video Dersler</div>
          <div class="card-meta" id="countVideo">0 Video</div>
        </div>
      </div>
      <div class="hub-card" onclick="openViewer('pdf')">
        <div class="card-icon-bg">üìï</div>
        <div class="card-icon-main">üìï</div>
        <div>
          <div class="card-title">Ders Notlarƒ±</div>
          <div class="card-meta" id="countPDF">0 Dosya</div>
        </div>
      </div>
      <div class="hub-card" onclick="openViewer('podcast')">
        <div class="card-icon-bg">üéß</div>
        <div class="card-icon-main">üéß</div>
        <div>
          <div class="card-title">Podcastler</div>
          <div class="card-meta" id="countPodcast">0 Kayƒ±t</div>
        </div>
      </div>
      <div class="hub-card" onclick="openViewer('html')">
        <div class="card-icon-bg">üìù</div>
        <div class="card-icon-main">üìù</div>
        <div>
          <div class="card-title">√ñzet Bilgiler</div>
          <div class="card-meta" id="countHtml">0 Not</div>
        </div>
      </div>
      <div class="hub-card" onclick="openViewer('test')">
        <div class="card-icon-bg">üß†</div>
        <div class="card-icon-main">üß†</div>
        <div>
          <div class="card-title">Konu Testleri</div>
          <div class="card-meta" id="countTest">0 Test</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAM EKRAN G√ñR√úNT√úLEYƒ∞Cƒ∞ -->
  <div class="viewer-overlay" id="viewerOverlay">
    <div class="viewer-header">
      <h3 style="margin:0;" id="viewerTitle">ƒ∞√ßerikler</h3>
      <button onclick="closeViewer()"
        style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úï</button>
    </div>
    <div class="viewer-body" id="viewerContent"></div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal"
    style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; display:none; justify-content:center; align-items:center; flex-direction:column;">
    <div style="width:90%; max-width:1000px; aspect-ratio:16/9; position:relative;">
      <div id="videoPlayer"></div>
    </div>
    <button onclick="closeVideo()"
      style="margin-top:20px; padding:10px 30px; background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2); border-radius:30px; cursor:pointer;">Kapat</button>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, query, orderBy, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let currentTopicId = null;
    let allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };
    let userProgress = {};

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      currentTopicId = urlParams.get('id');
      if (!currentTopicId) return window.location.href = '/pages/konular.html';

      onAuthStateChanged(auth, async (user) => {
        if (user) await loadUserProgress(user.uid);
        await loadTopicData();
      });
    });

    async function loadUserProgress(uid) {
      try {
        const docRef = doc(db, `users/${uid}/progress/${currentTopicId}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) userProgress = docSnap.data().completedMaterials || {};
      } catch (e) { }
    }

    async function loadTopicData() {
      const topicSnap = await getDoc(doc(db, "topics", currentTopicId));
      if (!topicSnap.exists()) return;

      const data = topicSnap.data();
      document.getElementById('topicTitle').innerText = data.title;
      document.title = `${data.title} | GOLD GYS`;

      // ƒ∞statistikleri Doldur (Veritabanƒ±nda bu alanlar varsa)
      document.getElementById('examQCount').innerText = data.totalQuestionTarget || '3'; // √ñrnek: Sƒ±navda 3 soru
      document.getElementById('totalQCount').innerText = '50+'; // Demo
      // document.getElementById('solvedQCount').innerText = ... (User stats'tan √ßekilebilir)

      const q = query(collection(db, `topics/${currentTopicId}/lessons`), orderBy("order", "asc"));
      const snapshot = await getDocs(q);

      allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };

      snapshot.forEach(doc => {
        const lesson = doc.data();
        if (lesson.materials) {
          lesson.materials.forEach(mat => {
            const matId = mat.id || `${doc.id}_${Math.random().toString(36).substr(2, 9)}`;
            const item = { ...mat, id: matId, lessonTitle: lesson.title };
            if (allMaterials[mat.type]) allMaterials[mat.type].push(item);
          });
        }
      });

      // Demo Testler
      allMaterials.test.push(
        { id: 't1', title: 'Hƒ±zlƒ± Tarama Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=quick` },
        { id: 't2', title: 'Kapsamlƒ± Konu Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=full` }
      );

      updateStats();
    }

    function updateStats() {
      let total = 0, completed = 0;
      ['video', 'pdf', 'podcast', 'html', 'test'].forEach(type => {
        const count = allMaterials[type].length;
        document.getElementById(`count${type.charAt(0).toUpperCase() + type.slice(1)}`).innerText = `${count} ƒ∞√ßerik`;
        total += count;
        completed += allMaterials[type].filter(i => userProgress[i.id]).length;
      });

      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progressText').innerText = `%${percent}`;
      document.getElementById('progressRing').setAttribute('stroke-dasharray', `${percent}, 100`);
    }

    // --- VIEWER ---
    window.openViewer = (type) => {
      const overlay = document.getElementById('viewerOverlay');
      const content = document.getElementById('viewerContent');
      const title = document.getElementById('viewerTitle');

      const titles = { video: 'Video Dersler', pdf: 'Ders Notlarƒ±', podcast: 'Podcastler', html: '√ñzet Bilgiler', test: 'Konu Testleri' };
      title.innerText = titles[type];

      content.innerHTML = '';
      const items = allMaterials[type];

      if (items.length === 0) {
        content.innerHTML = '<div class="text-center p-5 text-muted">Bu kategoride i√ßerik bulunmuyor.</div>';
      } else {
        items.forEach(item => {
          const isCompleted = userProgress[item.id];
          const div = document.createElement('div');
          div.className = 'content-list-item';
          div.onclick = () => playContent(item);

          div.innerHTML = `
                        <div style="width:24px; height:24px; border:2px solid var(--text-muted); border-radius:50%; display:flex; align-items:center; justify-content:center; background:${isCompleted ? 'var(--color-success)' : 'transparent'}; border-color:${isCompleted ? 'var(--color-success)' : 'var(--text-muted)'}; color:white; font-size:12px;">${isCompleted ? '‚úì' : ''}</div>
                        <div style="flex:1">
                            <div style="font-weight:600; font-size:1rem;">${item.title}</div>
                            <small class="text-muted">${item.lessonTitle || 'Genel'}</small>
                        </div>
                        <div style="color:var(--color-primary); font-weight:bold;">A√á</div>
                    `;
          content.appendChild(div);
        });
      }
      overlay.classList.add('active');
    };

    window.closeViewer = () => {
      document.getElementById('viewerOverlay').classList.remove('active');
    };

    window.playContent = (item) => {
      if (item.type === 'video') {
        let videoId = '';
        if (item.url.includes('youtu')) {
          const urlObj = new URL(item.url);
          if (item.url.includes('watch')) videoId = urlObj.searchParams.get('v');
          else if (item.url.includes('embed')) videoId = urlObj.pathname.split('/').pop();
          else if (item.url.includes('youtu.be')) videoId = urlObj.pathname.substring(1);
        }
        const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        document.getElementById('videoPlayer').innerHTML = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen style="width:100%; height:100%; border-radius:12px;"></iframe>`;
        document.getElementById('videoModal').style.display = 'flex';

        // Otomatik tamamlandƒ± i≈üaretle
        markComplete(item.id);
      }
      else if (item.type === 'pdf') {
        window.open(item.url, '_blank');
        markComplete(item.id);
      }
      else if (item.type === 'html') {
        const content = document.getElementById('viewerContent');
        content.innerHTML = `
                    <button onclick="openViewer('html')" class="btn btn-sm btn-secondary mb-4">‚Üê Listeye D√∂n</button>
                    <div style="font-size:1.1rem; line-height:1.8; max-width:800px; margin:0 auto;">${item.url}</div>
                    <div class="text-center mt-5"><button class="btn btn-success" onclick="markComplete('${item.id}'); openViewer('html');">‚úÖ Okudum, Tamamla</button></div>
                `;
      }
      else if (item.type === 'test') {
        window.location.href = item.url;
      }
    };

    window.closeVideo = () => {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoPlayer').innerHTML = '';
    };

    window.markComplete = async (id) => {
      if (!auth.currentUser) return;
      userProgress[id] = true;
      updateStats();
      try {
        const uid = auth.currentUser.uid;
        await setDoc(doc(db, `users/${uid}/progress/${currentTopicId}`), {
          completedMaterials: userProgress,
          lastUpdated: serverTimestamp()
        }, { merge: true });
      } catch (e) { }
    };
  </script>
</body>

</html>