<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konu DetayÄ± | GOLD GYS</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F172A'/><text x='50' y='70' font-family='serif' font-size='60' fill='%23D4AF37' text-anchor='middle' font-weight='bold'>G</text></svg>">
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    /* --- PREMIUM HUB TASARIMI (V3) --- */
    .hub-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      animation: fadeIn 0.5s ease;
    }

    /* Header KartÄ± (YENÄ°) */
    .topic-hero-card {
      background: linear-gradient(135deg, var(--bg-surface), var(--bg-body));
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      text-align: center;
    }

    .topic-hero-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
    }

    .back-link-wrapper {
      position: absolute;
      top: 20px;
      left: 20px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--bg-hover);
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .back-link:hover {
      background: var(--bg-surface);
      color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    .hub-title {
      font-family: var(--font-family-serif);
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--text-main);
      margin: 10px 0;
      letter-spacing: -0.5px;
      line-height: 1.3;
    }

    .hub-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Ä°statistik KartlarÄ± */
    .stats-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .stat-pill {
      background: var(--bg-body);
      border: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-main);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .stat-pill:hover {
      transform: translateY(-2px);
      border-color: var(--color-primary);
    }

    .stat-pill-icon {
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    .stat-pill strong {
      font-weight: 700;
      margin-left: 4px;
    }

    /* Grid */
    .hub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
    }

    .hub-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 220px;
    }

    .hub-card:hover {
      transform: translateY(-8px);
      border-color: var(--color-primary);
      box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.2);
    }

    .card-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      background: var(--bg-hover);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s;
    }

    .hub-card:hover .card-icon {
      transform: scale(1.1);
      background: rgba(212, 175, 55, 0.1);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 5px;
    }

    .card-meta {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* --- FULL SCREEN VIEWER (TAM EKRAN LÄ°STE VE Ä°Ã‡ERÄ°K) --- */
    .viewer-overlay {
      position: fixed;
      /* Sayfadan baÄŸÄ±msÄ±z, ekrana sabit */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-body);
      /* Arka plan rengi */
      z-index: 9999;
      /* En Ã¼stte olmasÄ± iÃ§in yÃ¼ksek deÄŸer */
      display: none;
      /* VarsayÄ±lan gizli */
      flex-direction: column;
      overflow: hidden;
      /* TaÅŸmalarÄ± engelle */
    }

    .viewer-overlay.active {
      display: flex !important;
      /* Active sÄ±nÄ±fÄ± gelince gÃ¶rÃ¼nÃ¼r yap */
    }

    .viewer-header {
      flex-shrink: 0;
      /* BaÅŸlÄ±k kÃ¼Ã§Ã¼lmesin */
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-surface);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .viewer-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .close-viewer {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      color: var(--text-main);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .close-viewer:hover {
      background: var(--color-danger);
      color: white;
      border-color: var(--color-danger);
    }

    /* Ä°Ã§erik GÃ¶vdesi */
    .viewer-body {
      flex: 1;
      overflow-y: auto;
      /* Sadece burasÄ± kaydÄ±rÄ±lsÄ±n */
      padding: 20px;
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      /* Scrollbar gizleme */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .viewer-body::-webkit-scrollbar {
      display: none;
    }

    /* Liste ElemanlarÄ± TasarÄ±mÄ± */
    .content-list-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    .content-list-item:hover {
      transform: translateX(5px);
      border-color: var(--color-primary);
      background: var(--bg-hover);
    }

    .item-status {
      width: 24px;
      height: 24px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .item-status.completed {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }

    .item-status.completed::after {
      content: 'âœ“';
      font-size: 14px;
      font-weight: bold;
    }

    /* HTML Not Okuyucu (Tam Ekran Hissi) */
    .note-reader-content {
      font-size: 1.2rem;
      line-height: 1.8;
      color: var(--text-main);
      font-family: 'Georgia', serif;
      /* Okuma iÃ§in serif */
      background: transparent;
      /* Kart gÃ¶rÃ¼nÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±, kaÄŸÄ±t hissi */
      padding: 0;
      border: none;
      box-shadow: none;
    }

    .note-reader-content h1,
    .note-reader-content h2,
    .note-reader-content h3 {
      font-family: var(--font-family-sans);
      color: var(--color-primary);
      margin-top: 1.5em;
    }

    .note-reader-content ul,
    .note-reader-content ol {
      padding-left: 20px;
      margin-bottom: 1em;
    }

    .note-reader-content li {
      margin-bottom: 0.5em;
    }

    /* --- VIDEO MODAL DÃœZELTMELERÄ° --- */
    #videoModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      /* Tam siyah yerine Ã§ok koyu opak */
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }

    /* Video Wrapper: OrantÄ±lÄ± ve Merkezde */
    .video-wrapper-modal {
      position: relative;
      width: 90%;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      /* En-Boy oranÄ±nÄ± kilitler */
      background: #000;
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }

    /* Iframe: Wrapper'Ä± tam doldurur */
    .video-wrapper-modal iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Kapatma Butonu: Videonun saÄŸ Ã¼st kÃ¶ÅŸesine deÄŸil, ekranÄ±n saÄŸÄ±na sabit */
    .video-close-btn {
      position: absolute;
      top: 30px;
      right: 30px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px 24px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      z-index: 3001;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .video-close-btn:hover {
      background: var(--color-primary);
      color: #000;
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }

    /* Mobil Uyumluluk */
    @media (max-width: 768px) {
      .video-wrapper-modal {
        width: 100%;
        border-radius: 0;
      }

      .video-close-btn {
        top: 15px;
        right: 15px;
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <!-- ANA HUB (KATEGORÄ°LER) -->
  <div class="dashboard-container hub-container" id="mainHub">

    <!-- Yeni Hero Card -->
    <div class="topic-hero-card">
      <div class="back-link-wrapper">
        <a href="/pages/konular.html" class="back-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          Konulara DÃ¶n
        </a>
      </div>

      <h1 class="hub-title" id="topicTitle">YÃ¼kleniyor...</h1>
      <p class="hub-subtitle" id="topicDesc">Konu detaylarÄ± ve ilerleme durumunuz.</p>

      <!-- Ä°statistikler -->
      <div class="stats-row">
        <div class="stat-pill" onclick="goToMistakes()">
          <span class="stat-pill-icon">âš ï¸</span>
          <span>YanlÄ±ÅŸ: <strong id="statWrong">0</strong></span>
        </div>
        <div class="stat-pill" onclick="goToFavorites()">
          <span class="stat-pill-icon">â­</span>
          <span>Favori: <strong id="statFav">0</strong></span>
        </div>
        <div class="stat-pill">
          <span class="stat-pill-icon">âœ…</span>
          <span>Ã‡Ã¶zÃ¼len: <strong id="statCorrect">0</strong></span>
        </div>
      </div>
    </div>

    <div class="hub-grid">
      <div class="hub-card" onclick="openViewer('video')">
        <div class="card-icon">ğŸ¥</div>
        <div class="card-title">Video Dersler</div>
        <div class="card-meta" id="countVideo">0 Ä°Ã§erik</div>
      </div>
      <div class="hub-card" onclick="openViewer('pdf')">
        <div class="card-icon">ğŸ“•</div>
        <div class="card-title">Ders NotlarÄ±</div>
        <div class="card-meta" id="countPDF">0 Dosya</div>
      </div>
      <div class="hub-card" onclick="openViewer('podcast')">
        <div class="card-icon">ğŸ§</div>
        <div class="card-title">Podcastler</div>
        <div class="card-meta" id="countPodcast">0 KayÄ±t</div>
      </div>
      <div class="hub-card" onclick="openViewer('html')">
        <div class="card-icon">ğŸ“</div>
        <div class="card-title">Ã–zet Bilgiler</div>
        <div class="card-meta" id="countHtml">0 Not</div>
      </div>
      <div class="hub-card" onclick="openViewer('test')">
        <div class="card-icon">ğŸ§ </div>
        <div class="card-title">Konu Testleri</div>
        <div class="card-meta" id="countTest">0 Test</div>
      </div>
    </div>
  </div>

  <!-- TAM EKRAN GÃ–RÃœNTÃœLEYÄ°CÄ° -->
  <div class="viewer-overlay" id="viewerOverlay">
    <div class="viewer-header">
      <h2 class="viewer-title" id="viewerTitle">Ä°Ã§erikler</h2>
      <button class="close-viewer" onclick="closeViewer()">âœ•</button>
    </div>
    <div class="viewer-body" id="viewerContent">
      <!-- Liste veya Ä°Ã§erik Buraya Gelecek -->
    </div>
  </div>

  <!-- Video Modal (TAM EKRAN) -->
  <!-- Video Modal (TAM EKRAN) -->
  <div id="videoModal">
    <!-- Kapatma butonu wrapper dÄ±ÅŸÄ±na alÄ±ndÄ± -->
    <button class="video-close-btn" onclick="closeVideo()">
      <span>âœ•</span> Kapat
    </button>

    <div class="video-wrapper-modal">
      <div id="videoPlayer" style="width:100%; height:100%;"></div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, query, orderBy, setDoc, serverTimestamp, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let currentTopicId = null;
    let currentTopicTitle = "";
    let allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };
    let userProgress = {};

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      currentTopicId = urlParams.get('id');
      if (!currentTopicId) return window.location.href = '/pages/konular.html';

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadUserProgress(user.uid);
          await loadUserStats(user.uid);
        }
        await loadTopicData();
      });
    });

    async function loadUserProgress(uid) {
      try {
        const docRef = doc(db, `users/${uid}/progress/${currentTopicId}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) userProgress = docSnap.data().completedMaterials || {};
      } catch (e) { }
    }

    async function loadUserStats(uid) {
      try {
        // YanlÄ±ÅŸ SayÄ±sÄ±
        const wrongsQ = query(collection(db, `users/${uid}/wrongs`), where("category", "==", currentTopicTitle));
        const wrongsSnap = await getCountFromServer(collection(db, `users/${uid}/wrongs`));
        document.getElementById('statWrong').innerText = wrongsSnap.data().count;

        // Favori SayÄ±sÄ±
        const favsSnap = await getCountFromServer(collection(db, `users/${uid}/favorites`));
        document.getElementById('statFav').innerText = favsSnap.data().count;

        document.getElementById('statCorrect').innerText = "-";
      } catch (e) { console.warn("Ä°statistik hatasÄ±:", e); }
    }

    async function loadTopicData() {
      const topicSnap = await getDoc(doc(db, "topics", currentTopicId));
      if (!topicSnap.exists()) return;

      const data = topicSnap.data();
      currentTopicTitle = data.title;
      document.getElementById('topicTitle').innerText = data.title;
      document.title = `${data.title} | GOLD GYS`;
      if (data.description) document.getElementById('topicDesc').innerText = data.description;

      const q = query(collection(db, `topics/${currentTopicId}/lessons`), orderBy("order", "asc"));
      const snapshot = await getDocs(q);

      allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };

      snapshot.forEach(doc => {
        const lesson = doc.data();
        if (lesson.materials) {
          lesson.materials.forEach(mat => {
            const matId = mat.id || `${doc.id}_${Math.random().toString(36).substr(2, 9)}`;
            const item = { ...mat, id: matId, lessonTitle: lesson.title };
            if (allMaterials[mat.type]) allMaterials[mat.type].push(item);
          });
        }
      });

      // Demo Testler
      allMaterials.test.push(
        { id: 't1', title: 'HÄ±zlÄ± Tarama Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=quick` },
        { id: 't2', title: 'KapsamlÄ± Konu Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=full` }
      );

      updateStats();
    }

    function updateStats() {
      let total = 0, completed = 0;
      ['video', 'pdf', 'podcast', 'html', 'test'].forEach(type => {
        const count = allMaterials[type].length;
        const el = document.getElementById(`count${type.charAt(0).toUpperCase() + type.slice(1)}`);
        if (el) el.innerText = `${count} Ä°Ã§erik`;

        total += count;
        completed += allMaterials[type].filter(i => userProgress[i.id]).length;
      });
    }

    // --- VIEWER YÃ–NETÄ°MÄ° ---
    window.openViewer = (type) => {
      const overlay = document.getElementById('viewerOverlay');
      const content = document.getElementById('viewerContent');
      const title = document.getElementById('viewerTitle');

      const titles = { video: 'Video Dersler', pdf: 'Ders NotlarÄ±', podcast: 'Podcastler', html: 'Ã–zet Bilgiler', test: 'Konu Testleri' };

      // BaÅŸlÄ±ÄŸÄ± ayarla (Geri butonu varsa temizle)
      title.innerHTML = titles[type] || 'Ä°Ã§erikler';

      content.innerHTML = '';
      const items = allMaterials[type] || [];

      if (items.length === 0) {
        content.innerHTML = `
            <div class="text-center p-5" style="color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“­</div>
                <p>Bu kategoride henÃ¼z iÃ§erik eklenmemiÅŸ.</p>
            </div>`;
      } else {
        items.forEach(item => {
          const isCompleted = userProgress[item.id];
          const div = document.createElement('div');
          div.className = 'content-list-item';
          div.onclick = () => playContent(item);

          div.innerHTML = `
              <div class="item-status ${isCompleted ? 'completed' : ''}" id="status-${item.id}"></div>
              <div style="flex:1">
                  <div style="font-weight:600; font-size:1rem; color: var(--text-main);">${item.title}</div>
                  <small style="color:var(--text-muted);">${item.lessonTitle || 'Genel'}</small>
              </div>
              <div style="color:var(--color-primary); font-weight:bold; font-size: 0.9rem;">AÃ‡ &rarr;</div>
          `;
          content.appendChild(div);
        });
      }

      // Overlay'i aktif et
      overlay.classList.add('active');

      // Body scroll'u kilitle (Arka plan kaymasÄ±n)
      document.body.style.overflow = 'hidden';
    };

    window.closeViewer = () => {
      const overlay = document.getElementById('viewerOverlay');
      overlay.classList.remove('active');

      // Body scroll'u serbest bÄ±rak
      document.body.style.overflow = '';

      // Ä°Ã§eriÄŸi temizle (Animasyon bitince)
      setTimeout(() => {
        document.getElementById('viewerContent').innerHTML = '';
      }, 300);
    };

    // --- Ä°Ã‡ERÄ°K OYNATMA VE OTOMATÄ°K DÃœZELTME ---

    // 1. AkÄ±llÄ± Ä°Ã§erik OnarÄ±cÄ± Fonksiyon
    function processHtmlContent(htmlString) {
      // HTML'i geÃ§ici bir DOM nesnesine Ã§evir
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, 'text/html');

      // A) RESÄ°MLERÄ° ONAR
      const images = doc.querySelectorAll('img');
      images.forEach(img => {
        // BoÅŸ src varsa sil
        if (!img.src || img.src === window.location.href) {
          img.remove();
          return;
        }

        // HTTP -> HTTPS ZorlamasÄ± (GÃ¼venlik iÃ§in)
        if (img.src.startsWith('http://')) {
          img.src = img.src.replace('http://', 'https://');
        }

        // Hata durumunda Ã§alÄ±ÅŸacak inline kod ekle (Self-Healing)
        // Resim yÃ¼klenemezse (404), konsol hatasÄ±nÄ± engelleyemeyiz ama
        // kullanÄ±cÄ±ya kÄ±rÄ±k ikon yerine ÅŸÄ±k bir placeholder gÃ¶sterebiliriz veya gizleyebiliriz.
        img.setAttribute('onerror', "this.onerror=null; this.style.display='none';");

        // Stil iyileÅŸtirmesi (TaÅŸmalarÄ± engelle)
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.borderRadius = '8px';
        img.style.marginTop = '10px';
      });

      // B) LÄ°NKLERÄ° ONAR
      const links = doc.querySelectorAll('a');
      links.forEach(link => {
        // Linkleri yeni sekmede aÃ§maya zorla
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');

        // Link metni yoksa URL'i metin yap
        if (!link.innerText.trim()) {
          link.innerText = "BaÄŸlantÄ±yÄ± GÃ¶rÃ¼ntÃ¼le";
        }
      });

      return doc.body.innerHTML;
    }

    // 2. GÃ¼ncellenmiÅŸ Oynatma Fonksiyonu
    window.playContent = (item) => {
      const content = document.getElementById('viewerContent');
      const title = document.getElementById('viewerTitle');

      // Geri Butonu ve BaÅŸlÄ±k
      title.innerHTML = `
        <span onclick="openViewer('${item.type}')" style="cursor:pointer; opacity:0.7; display:flex; align-items:center; gap:5px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Geri
        </span> 
        <span style="margin-left:15px; border-left:1px solid var(--border-color); padding-left:15px;">${item.title}</span>
      `;

      let html = '';

      if (item.type === 'video') {
        let videoId = '';
        try {
          let safeUrl = item.url.trim();
          if (!safeUrl.startsWith('http')) safeUrl = `https://${safeUrl}`;
          const urlObj = new URL(safeUrl);

          if (safeUrl.includes('youtu')) {
            if (safeUrl.includes('watch')) videoId = urlObj.searchParams.get('v');
            else if (safeUrl.includes('embed')) videoId = urlObj.pathname.split('/').pop();
            else if (safeUrl.includes('youtu.be')) videoId = urlObj.pathname.substring(1);
          }
        } catch (e) { console.warn("URL HatasÄ±:", e); }

        if (videoId) {
          const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;

          // GÃœNCELLENMÄ°Å IFRAME (Hata Giderici Ä°zinler Eklendi)
          document.getElementById('videoPlayer').innerHTML = `
            <iframe 
                src="${embedUrl}" 
                style="width:100%; height:100%; border:none;" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                referrerpolicy="strict-origin-when-cross-origin" 
                allowfullscreen>
            </iframe>`;

          document.getElementById('videoModal').style.display = 'flex';
          markComplete(item.id);
          return;
        } else {
          alert("GeÃ§ersiz video linki.");
        }
      }
      else if (item.type === 'pdf') {
        window.open(item.url, '_blank');
        markComplete(item.id);
      }
      else if (item.type === 'podcast') {
        html = `
            <div class="card p-5 text-center" style="background:var(--bg-surface); border-radius:20px; max-width:600px; margin:0 auto;">
                <div style="font-size:4rem; margin-bottom:20px;">ğŸ§</div>
                <h3>${item.title}</h3>
                <audio controls style="width:100%; margin-top:20px;" autoplay>
                    <source src="${item.url}" type="audio/mpeg">
                    TarayÄ±cÄ±nÄ±z ses dosyasÄ±nÄ± desteklemiyor.
                </audio>
            </div>`;
      }
      else if (item.type === 'html') {
        // --- BURADA OTOMATÄ°K DÃœZELTME DEVREYE GÄ°RÄ°YOR ---
        const safeHtml = processHtmlContent(item.url);

        html = `
            <div class="note-reader-content" style="max-width:800px; margin:0 auto;">
                ${safeHtml}
            </div>
            <div class="text-center mt-5" style="padding-bottom: 50px;">
                <button class="btn btn-success btn-lg" onclick="markComplete('${item.id}'); openViewer('html');">
                    âœ… Okudum, Tamamla
                </button>
            </div>
        `;
      }
      else if (item.type === 'test') {
        window.location.href = item.url;
        return;
      }

      if (html) content.innerHTML = html;
    };

    window.closeVideo = () => {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoPlayer').innerHTML = '';
    };

    window.markComplete = async (id) => {
      if (!auth.currentUser) return;
      userProgress[id] = true;
      updateStats();
      try {
        const uid = auth.currentUser.uid;
        await setDoc(doc(db, `users/${uid}/progress/${currentTopicId}`), {
          completedMaterials: userProgress,
          lastUpdated: serverTimestamp()
        }, { merge: true });
      } catch (e) { }
    };

    // YÃ¶nlendirmeler
    window.goToMistakes = () => {
      const topicName = encodeURIComponent(currentTopicTitle);
      window.location.href = `/pages/yanlislarim.html?category=${topicName}`;
    };

    window.goToFavorites = () => {
      const topicName = encodeURIComponent(currentTopicTitle);
      window.location.href = `/pages/favoriler.html?category=${topicName}`;
    };

  </script>
</body>

</html>