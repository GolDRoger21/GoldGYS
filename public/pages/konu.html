<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konu Detayƒ± | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    /* --- KONU DETAY √ñZEL STƒ∞LLERƒ∞ --- */
    .topic-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
      height: calc(100vh - var(--header-height) - 40px);
      /* Tam ekran hissi */
    }

    /* SOL KOLON: Ders Listesi */
    .lessons-sidebar {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .lessons-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-hover);
    }

    .lessons-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .lesson-item {
      padding: 15px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
      border: 1px solid transparent;
    }

    .lesson-item:hover {
      background: var(--bg-hover);
    }

    .lesson-item.active {
      background: rgba(212, 175, 55, 0.1);
      border-color: var(--color-primary);
      color: var(--color-primary);
      font-weight: 600;
    }

    .lesson-status {
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .lesson-item.completed .lesson-status {
      background: var(--color-success);
      border-color: var(--color-success);
    }

    /* SAƒû KOLON: ƒ∞√ßerik Alanƒ± */
    .content-area {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      overflow-y: auto;
      position: relative;
    }

    .content-header {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ƒ∞√ßerik Tipleri */
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .pdf-embed {
      width: 100%;
      height: 600px;
      border: none;
      border-radius: 8px;
    }

    .note-content {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-main);
    }

    /* Mobil Uyum */
    @media (max-width: 900px) {
      .topic-layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      .lessons-sidebar {
        order: 2;
        max-height: 400px;
      }

      .content-area {
        order: 1;
        min-height: 400px;
      }
    }

    /* Odak Modu Stilleri */
    body.focus-mode .app-header,
    body.focus-mode .app-sidebar {
      display: none !important;
    }

    body.focus-mode .dashboard-container {
      max-width: 100%;
      padding: 0;
      margin: 0;
    }

    body.focus-mode .topic-layout {
      grid-template-columns: 1fr;
      /* Tek kolon */
      height: 100vh;
    }

    body.focus-mode .lessons-sidebar {
      display: none;
      /* Ders listesini gizle */
    }

    body.focus-mode .content-area {
      border: none;
      border-radius: 0;
      height: 100vh;
      padding: 20px;
    }

    /* Odak Modu √áƒ±kƒ±≈ü Butonu */
    .exit-focus-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      display: none;
      cursor: pointer;
      backdrop-filter: blur(5px);
    }

    body.focus-mode .exit-focus-btn {
      display: block;
    }
  </style>
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <!-- Odak Modu √áƒ±kƒ±≈ü Butonu -->
  <button class="exit-focus-btn" onclick="toggleFocusMode()">‚úï Odak Modundan √áƒ±k</button>

  <div class="dashboard-container" style="max-width: 1600px;"> <!-- Geni≈ü ekran -->
    <div class="topic-layout">

      <!-- SOL: Ders Listesi -->
      <div class="lessons-sidebar">
        <div class="lessons-header">
          <a href="/pages/konular.html" class="text-muted small mb-2 d-block">‚Üê Konulara D√∂n</a>
          <h3 class="m-0" id="topicTitle">Y√ºkleniyor...</h3>
          <div class="progress-bar-container mt-3">
            <div class="progress-bar" id="topicProgress" style="width: 0%"></div>
          </div>
          <small class="text-muted" id="progressText">%0 Tamamlandƒ±</small>
        </div>
        <div id="lessonsList" class="lessons-list">
          <!-- Dersler buraya gelecek -->
        </div>
      </div>

      <!-- SAƒû: ƒ∞√ßerik -->
      <div class="content-area" id="contentArea">
        <div class="d-flex justify-content-end mb-3">
          <button class="btn btn-sm btn-outline-primary" onclick="toggleFocusMode()">
            üëÅÔ∏è Odak Modu
          </button>
        </div>
        <div class="text-center p-5 text-muted">
          <h3>üëã Ho≈ü Geldiniz</h3>
          <p>Soldaki listeden bir ders se√ßerek √ßalƒ±≈ümaya ba≈ülayƒ±n.</p>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, query, orderBy, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let currentTopicId = null;
    let lessonsData = [];
    let userProgress = {}; // { lessonId: true/false }

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      currentTopicId = urlParams.get('id');

      if (!currentTopicId) {
        window.location.href = '/pages/konular.html';
        return;
      }

      // Auth kontrol√º ve ilerleme verisini √ßekme
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadUserProgress(user.uid);
        }
        await loadTopicAndLessons();
      });
    });

    async function loadUserProgress(uid) {
      try {
        const docRef = doc(db, `users/${uid}/progress/${currentTopicId}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          userProgress = docSnap.data().completedLessons || {};
        }
      } catch (e) { console.error("Progress error:", e); }
    }

    async function loadTopicAndLessons() {
      try {
        // 1. Ana Konu Bilgisi
        const topicSnap = await getDoc(doc(db, "topics", currentTopicId));
        if (!topicSnap.exists()) return alert("Konu bulunamadƒ±.");

        const topicData = topicSnap.data();
        document.getElementById('topicTitle').innerText = topicData.title;
        document.title = `${topicData.title} | GOLD GYS`;

        // 2. Dersleri √áek (Subcollection)
        const q = query(collection(db, `topics/${currentTopicId}/lessons`), orderBy("order", "asc"));
        const snapshot = await getDocs(q);

        lessonsData = [];
        snapshot.forEach(doc => lessonsData.push({ id: doc.id, ...doc.data() }));

        renderLessonsList();
        updateProgressBar();

      } catch (error) {
        console.error("Hata:", error);
      }
    }

    function renderLessonsList() {
      const list = document.getElementById('lessonsList');
      list.innerHTML = '';

      if (lessonsData.length === 0) {
        list.innerHTML = '<div class="p-3 text-muted text-center">Hen√ºz ders eklenmemi≈ü.</div>';
        return;
      }

      lessonsData.forEach((lesson, index) => {
        const isCompleted = userProgress[lesson.id] === true;
        const div = document.createElement('div');
        div.className = `lesson-item ${isCompleted ? 'completed' : ''}`;
        div.onclick = () => loadLessonContent(index);

        div.innerHTML = `
                    <div class="lesson-status"></div>
                    <div>
                        <div style="font-weight:500;">${lesson.title}</div>
                        <small class="text-muted">
                            ${lesson.videoUrl ? 'üì∫ ' : ''}
                            ${lesson.pdfUrl ? 'üìÑ ' : ''}
                            ${lesson.podcastUrl ? 'üéß ' : ''}
                        </small>
                    </div>
                `;
        list.appendChild(div);
      });
    }

    function loadLessonContent(index) {
      const lesson = lessonsData[index];
      const container = document.getElementById('contentArea');

      // Aktif sƒ±nƒ±fƒ±nƒ± g√ºncelle
      document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.lesson-item')[index].classList.add('active');

      let contentHtml = '';

      // Video
      if (lesson.videoUrl) {
        const videoId = lesson.videoUrl.split('v=')[1] || lesson.videoUrl.split('/').pop();
        contentHtml += `
                    <div class="video-wrapper">
                        <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                    </div>
                `;
      }

      // Podcast
      if (lesson.podcastUrl) {
        contentHtml += `
                    <div class="card p-3 mb-4 bg-hover">
                        <h5 class="mb-2">üéß Sesli Anlatƒ±m</h5>
                        <audio controls style="width:100%">
                            <source src="${lesson.podcastUrl}" type="audio/mpeg">
                        </audio>
                    </div>
                `;
      }

      // PDF
      if (lesson.pdfUrl) {
        contentHtml += `
                    <div class="mb-4">
                        <a href="${lesson.pdfUrl}" target="_blank" class="btn btn-secondary w-100">
                            üìÑ PDF Dok√ºmanƒ±nƒ± A√ß / ƒ∞ndir
                        </a>
                    </div>
                `;
      }

      // HTML Not
      if (lesson.content) {
        contentHtml += `
                    <div class="note-content">
                        ${lesson.content}
                    </div>
                `;
      }

      container.innerHTML = `
                <div class="content-header">
                    <h2 class="m-0">${lesson.title}</h2>
                    <button class="btn btn-success" onclick="markAsCompleted('${lesson.id}')">
                        ‚úÖ Tamamlandƒ± ƒ∞≈üaretle
                    </button>
                </div>
                ${contentHtml}
            `;
    }

    // Global Fonksiyon: Tamamlandƒ± ƒ∞≈üaretle
    window.markAsCompleted = async (lessonId) => {
      if (!auth.currentUser) return alert("Giri≈ü yapmalƒ±sƒ±nƒ±z.");

      userProgress[lessonId] = true;
      renderLessonsList(); // Listeyi g√ºncelle (Ye≈üil tik i√ßin)
      updateProgressBar();

      // Veritabanƒ±na Kaydet
      try {
        const uid = auth.currentUser.uid;
        const docRef = doc(db, `users/${uid}/progress/${currentTopicId}`);
        await setDoc(docRef, {
          completedLessons: userProgress,
          lastUpdated: serverTimestamp()
        }, { merge: true });
      } catch (e) { console.error(e); }
    };

    function updateProgressBar() {
      const total = lessonsData.length;
      if (total === 0) return;

      const completed = Object.values(userProgress).filter(v => v === true).length;
      const percent = Math.round((completed / total) * 100);

      document.getElementById('topicProgress').style.width = `${percent}%`;
      document.getElementById('progressText').innerText = `%${percent} Tamamlandƒ±`;
    }

    window.toggleFocusMode = () => {
      document.body.classList.toggle('focus-mode');
    };
  </script>
</body>

</html>