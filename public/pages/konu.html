<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konu Detayƒ± | GOLD GYS</title>
  <link rel="stylesheet" href="../styles/tokens.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <style>
    /* --- PREMIUM HUB TASARIMI (V3) --- */
    .hub-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      animation: fadeIn 0.5s ease;
    }

    /* Header Kartƒ± (YENƒ∞) */
    .topic-hero-card {
      background: linear-gradient(135deg, var(--bg-surface), var(--bg-body));
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      text-align: center;
    }

    .topic-hero-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
    }

    .back-link-wrapper {
      position: absolute;
      top: 20px;
      left: 20px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--bg-hover);
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .back-link:hover {
      background: var(--bg-surface);
      color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    .hub-title {
      font-family: var(--font-family-serif);
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--text-main);
      margin: 10px 0;
      letter-spacing: -0.5px;
      line-height: 1.3;
    }

    .hub-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    /* ƒ∞statistik Kartlarƒ± */
    .stats-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .stat-pill {
      background: var(--bg-body);
      border: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-main);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .stat-pill:hover {
      transform: translateY(-2px);
      border-color: var(--color-primary);
    }

    .stat-pill-icon {
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    .stat-pill strong {
      font-weight: 700;
      margin-left: 4px;
    }

    /* Grid */
    .hub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
    }

    .hub-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 220px;
    }

    .hub-card:hover {
      transform: translateY(-8px);
      border-color: var(--color-primary);
      box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.2);
    }

    .card-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      background: var(--bg-hover);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s;
    }

    .hub-card:hover .card-icon {
      transform: scale(1.1);
      background: rgba(212, 175, 55, 0.1);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 5px;
    }

    .card-meta {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* --- FULL SCREEN VIEWER (TAM EKRAN D√úZELTME) --- */
    .viewer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-body);
      z-index: 2000;
      display: none;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    .viewer-overlay.active {
      display: flex;
    }

    .viewer-header {
      padding: 15px 40px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-surface);
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    .viewer-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-viewer {
      background: var(--bg-hover);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: var(--text-main);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .close-viewer:hover {
      background: var(--color-danger);
      color: white;
    }

    /* Scroll Bar D√ºzeltmesi: Body tam ekran, scroll i√ßeride DEƒûƒ∞L, ana akƒ±≈üta */
    .viewer-body {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      /* Scroll bar'ƒ± g√ºzelle≈ütir */
      scrollbar-width: thin;
      scrollbar-color: var(--color-primary) var(--bg-hover);
    }

    /* HTML Not Okuyucu (Tam Ekran Hissi) */
    .note-reader-content {
      font-size: 1.2rem;
      line-height: 1.8;
      color: var(--text-main);
      font-family: 'Georgia', serif;
      /* Okuma i√ßin serif */
      background: transparent;
      /* Kart g√∂r√ºn√ºm√º kaldƒ±rƒ±ldƒ±, kaƒüƒ±t hissi */
      padding: 0;
      border: none;
      box-shadow: none;
    }

    .note-reader-content h1,
    .note-reader-content h2,
    .note-reader-content h3 {
      font-family: var(--font-family-sans);
      color: var(--color-primary);
      margin-top: 1.5em;
    }

    .note-reader-content ul,
    .note-reader-content ol {
      padding-left: 20px;
      margin-bottom: 1em;
    }

    .note-reader-content li {
      margin-bottom: 0.5em;
    }

    /* Video Modal (TAM EKRAN D√úZELTME) */
    #videoModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 3000;
      /* Tamamen siyah arka plan */
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    /* Video Wrapper: Tam geni≈ülik */
    .video-wrapper-modal {
      width: 100%;
      height: 100%;
      max-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Iframe: Orantƒ±lƒ± ve b√ºy√ºk */
    .video-wrapper-modal iframe {
      width: 80vw;
      height: 80vh;
      /* Ekranƒ±n %80'ini kapla */
      max-width: 1280px;
      aspect-ratio: 16/9;
      border: none;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    }

    .video-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      backdrop-filter: blur(5px);
      transition: background 0.2s;
    }

    .video-close-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Liste G√∂r√ºn√ºm√º */
    .content-list-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .content-list-item:hover {
      transform: translateX(10px);
      border-color: var(--color-primary);
    }

    .item-status {
      width: 24px;
      height: 24px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .item-status.completed {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }

    .item-status.completed::after {
      content: '‚úì';
      font-size: 14px;
      font-weight: bold;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .topic-hero-card {
        padding: 30px 20px;
        text-align: center;
      }

      .back-link-wrapper {
        position: static;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
      }

      .hub-title {
        font-size: 1.8rem;
      }

      .stats-row {
        flex-direction: column;
        gap: 10px;
      }

      .stat-pill {
        justify-content: center;
        width: 100%;
      }

      .video-wrapper-modal iframe {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
      }
    }
  </style>
</head>

<body>
  <script type="module">
    import { initLayout } from '../js/ui-loader.js';
    document.addEventListener('DOMContentLoaded', () => initLayout());
  </script>

  <!-- ANA HUB (KATEGORƒ∞LER) -->
  <div class="dashboard-container hub-container" id="mainHub">

    <!-- Yeni Hero Card -->
    <div class="topic-hero-card">
      <div class="back-link-wrapper">
        <a href="/pages/konular.html" class="back-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          Konulara D√∂n
        </a>
      </div>

      <h1 class="hub-title" id="topicTitle">Y√ºkleniyor...</h1>
      <p class="hub-subtitle" id="topicDesc">Konu detaylarƒ± ve ilerleme durumunuz.</p>

      <!-- ƒ∞statistikler -->
      <div class="stats-row">
        <div class="stat-pill" onclick="goToMistakes()">
          <span class="stat-pill-icon">‚ö†Ô∏è</span>
          <span>Yanlƒ±≈ü: <strong id="statWrong">0</strong></span>
        </div>
        <div class="stat-pill" onclick="goToFavorites()">
          <span class="stat-pill-icon">‚≠ê</span>
          <span>Favori: <strong id="statFav">0</strong></span>
        </div>
        <div class="stat-pill">
          <span class="stat-pill-icon">‚úÖ</span>
          <span>√á√∂z√ºlen: <strong id="statCorrect">0</strong></span>
        </div>
      </div>
    </div>

    <div class="hub-grid">
      <div class="hub-card" onclick="openViewer('video')">
        <div class="card-icon">üé•</div>
        <div class="card-title">Video Dersler</div>
        <div class="card-meta" id="countVideo">0 ƒ∞√ßerik</div>
      </div>
      <div class="hub-card" onclick="openViewer('pdf')">
        <div class="card-icon">üìï</div>
        <div class="card-title">Ders Notlarƒ±</div>
        <div class="card-meta" id="countPDF">0 Dosya</div>
      </div>
      <div class="hub-card" onclick="openViewer('podcast')">
        <div class="card-icon">üéß</div>
        <div class="card-title">Podcastler</div>
        <div class="card-meta" id="countPodcast">0 Kayƒ±t</div>
      </div>
      <div class="hub-card" onclick="openViewer('html')">
        <div class="card-icon">üìù</div>
        <div class="card-title">√ñzet Bilgiler</div>
        <div class="card-meta" id="countHtml">0 Not</div>
      </div>
      <div class="hub-card" onclick="openViewer('test')">
        <div class="card-icon">üß†</div>
        <div class="card-title">Konu Testleri</div>
        <div class="card-meta" id="countTest">0 Test</div>
      </div>
    </div>
  </div>

  <!-- TAM EKRAN G√ñR√úNT√úLEYƒ∞Cƒ∞ -->
  <div class="viewer-overlay" id="viewerOverlay">
    <div class="viewer-header">
      <h2 class="viewer-title" id="viewerTitle">ƒ∞√ßerikler</h2>
      <button class="close-viewer" onclick="closeViewer()">‚úï</button>
    </div>
    <div class="viewer-body" id="viewerContent">
      <!-- Liste veya ƒ∞√ßerik Buraya Gelecek -->
    </div>
  </div>

  <!-- Video Modal (TAM EKRAN) -->
  <div id="videoModal">
    <button class="video-close-btn" onclick="closeVideo()">‚úï Kapat</button>
    <div class="video-wrapper-modal">
      <div id="videoPlayer" style="width:100%; height:100%;"></div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, query, orderBy, setDoc, serverTimestamp, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let currentTopicId = null;
    let currentTopicTitle = "";
    let allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };
    let userProgress = {};

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      currentTopicId = urlParams.get('id');
      if (!currentTopicId) return window.location.href = '/pages/konular.html';

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadUserProgress(user.uid);
          await loadUserStats(user.uid);
        }
        await loadTopicData();
      });
    });

    async function loadUserProgress(uid) {
      try {
        const docRef = doc(db, `users/${uid}/progress/${currentTopicId}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) userProgress = docSnap.data().completedMaterials || {};
      } catch (e) { }
    }

    async function loadUserStats(uid) {
      try {
        // Yanlƒ±≈ü Sayƒ±sƒ±
        const wrongsQ = query(collection(db, `users/${uid}/wrongs`), where("category", "==", currentTopicTitle));
        const wrongsSnap = await getCountFromServer(collection(db, `users/${uid}/wrongs`));
        document.getElementById('statWrong').innerText = wrongsSnap.data().count;

        // Favori Sayƒ±sƒ±
        const favsSnap = await getCountFromServer(collection(db, `users/${uid}/favorites`));
        document.getElementById('statFav').innerText = favsSnap.data().count;

        document.getElementById('statCorrect').innerText = "-";
      } catch (e) { console.warn("ƒ∞statistik hatasƒ±:", e); }
    }

    async function loadTopicData() {
      const topicSnap = await getDoc(doc(db, "topics", currentTopicId));
      if (!topicSnap.exists()) return;

      const data = topicSnap.data();
      currentTopicTitle = data.title;
      document.getElementById('topicTitle').innerText = data.title;
      document.title = `${data.title} | GOLD GYS`;
      if (data.description) document.getElementById('topicDesc').innerText = data.description;

      const q = query(collection(db, `topics/${currentTopicId}/lessons`), orderBy("order", "asc"));
      const snapshot = await getDocs(q);

      allMaterials = { video: [], pdf: [], podcast: [], html: [], test: [] };

      snapshot.forEach(doc => {
        const lesson = doc.data();
        if (lesson.materials) {
          lesson.materials.forEach(mat => {
            const matId = mat.id || `${doc.id}_${Math.random().toString(36).substr(2, 9)}`;
            const item = { ...mat, id: matId, lessonTitle: lesson.title };
            if (allMaterials[mat.type]) allMaterials[mat.type].push(item);
          });
        }
      });

      // Demo Testler
      allMaterials.test.push(
        { id: 't1', title: 'Hƒ±zlƒ± Tarama Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=quick` },
        { id: 't2', title: 'Kapsamlƒ± Konu Testi', type: 'test', url: `/pages/test.html?topic=${currentTopicId}&mode=full` }
      );

      updateStats();
    }

    function updateStats() {
      let total = 0, completed = 0;
      ['video', 'pdf', 'podcast', 'html', 'test'].forEach(type => {
        const count = allMaterials[type].length;
        const el = document.getElementById(`count${type.charAt(0).toUpperCase() + type.slice(1)}`);
        if (el) el.innerText = `${count} ƒ∞√ßerik`;

        total += count;
        completed += allMaterials[type].filter(i => userProgress[i.id]).length;
      });
    }

    // --- VIEWER Y√ñNETƒ∞Mƒ∞ ---
    window.openViewer = (type) => {
      const overlay = document.getElementById('viewerOverlay');
      const content = document.getElementById('viewerContent');
      const title = document.getElementById('viewerTitle');

      const titles = { video: 'Video Dersler', pdf: 'Ders Notlarƒ±', podcast: 'Podcastler', html: '√ñzet Bilgiler', test: 'Konu Testleri' };
      title.innerText = titles[type];

      content.innerHTML = '';
      const items = allMaterials[type];

      if (items.length === 0) {
        content.innerHTML = '<div class="text-center p-5 text-muted">Bu kategoride i√ßerik bulunmuyor.</div>';
      } else {
        items.forEach(item => {
          const isCompleted = userProgress[item.id];
          const div = document.createElement('div');
          div.className = 'content-list-item';
          div.onclick = () => playContent(item);

          div.innerHTML = `
                        <div class="item-status ${isCompleted ? 'completed' : ''}" id="status-${item.id}"></div>
                        <div style="flex:1">
                            <div style="font-weight:600; font-size:1.1rem;">${item.title}</div>
                            <small class="text-muted">${item.lessonTitle || 'Genel'}</small>
                        </div>
                        <div style="color:var(--color-primary); font-weight:bold;">A√á</div>
                    `;
          content.appendChild(div);
        });
      }
      overlay.classList.add('active');
    };

    window.closeViewer = () => {
      document.getElementById('viewerOverlay').classList.remove('active');
      setTimeout(() => { document.getElementById('viewerContent').innerHTML = ''; }, 300);
    };

    // --- ƒ∞√áERƒ∞K OYNATMA (G√úNCELLENDƒ∞) ---
    window.playContent = (item) => {
      const content = document.getElementById('viewerContent');
      const title = document.getElementById('viewerTitle');

      // Geri Butonu
      title.innerHTML = `<span onclick="openViewer('${item.type}')" style="cursor:pointer; opacity:0.7;">‚Üê Geri</span> <span style="margin-left:10px;">${item.title}</span>`;

      let html = '';

      if (item.type === 'video') {
        let videoId = '';
        try {
          // URL d√ºzeltme (http ekleme)
          let safeUrl = item.url.trim();
          if (!safeUrl.startsWith('http')) safeUrl = `https://${safeUrl}`;

          const urlObj = new URL(safeUrl);

          if (safeUrl.includes('youtu')) {
            if (safeUrl.includes('watch')) videoId = urlObj.searchParams.get('v');
            else if (safeUrl.includes('embed')) videoId = urlObj.pathname.split('/').pop();
            else if (safeUrl.includes('youtu.be')) videoId = urlObj.pathname.substring(1);
          }
        } catch (e) { console.warn("URL Hatasƒ±:", e); }

        if (videoId) {
          const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
          // Video Player'ƒ± Modal ƒ∞√ßine Koy
          document.getElementById('videoPlayer').innerHTML = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen style="width:100%; height:100%;"></iframe>`;
          document.getElementById('videoModal').style.display = 'flex';
          markComplete(item.id);
          return; // HTML i√ßeriƒüi deƒüi≈ütirmeye gerek yok, modal a√ßƒ±ldƒ±
        } else {
          alert("Ge√ßersiz video linki.");
        }
      }
      else if (item.type === 'pdf') {
        window.open(item.url, '_blank');
        markComplete(item.id);
      }
      else if (item.type === 'podcast') {
        html = `
                    <div class="card p-5 text-center" style="background:var(--bg-surface); border-radius:20px;">
                        <div style="font-size:4rem; margin-bottom:20px;">üéß</div>
                        <h3>${item.title}</h3>
                        <audio controls style="width:100%; margin-top:20px;" autoplay>
                            <source src="${item.url}" type="audio/mpeg">
                        </audio>
                    </div>`;
      }
      else if (item.type === 'html') {
        html = `
                    <div class="note-reader-content" style="max-width:800px; margin:0 auto;">
                        ${item.url}
                    </div>
                    <div class="text-center mt-5">
                        <button class="btn btn-success btn-lg" onclick="markComplete('${item.id}'); openViewer('html');">
                            ‚úÖ Okudum, Tamamla
                        </button>
                    </div>
                `;
      }
      else if (item.type === 'test') {
        window.location.href = item.url;
        return;
      }

      if (html) content.innerHTML = html;
    };

    window.closeVideo = () => {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoPlayer').innerHTML = '';
    };

    window.markComplete = async (id) => {
      if (!auth.currentUser) return;
      userProgress[id] = true;
      updateStats();
      try {
        const uid = auth.currentUser.uid;
        await setDoc(doc(db, `users/${uid}/progress/${currentTopicId}`), {
          completedMaterials: userProgress,
          lastUpdated: serverTimestamp()
        }, { merge: true });
      } catch (e) { }
    };

    // Y√∂nlendirmeler
    window.goToMistakes = () => {
      const topicName = encodeURIComponent(currentTopicTitle);
      window.location.href = `/pages/yanlislarim.html?category=${topicName}`;
    };

    window.goToFavorites = () => {
      const topicName = encodeURIComponent(currentTopicTitle);
      window.location.href = `/pages/favoriler.html?category=${topicName}`;
    };

  </script>
</body>

</html>