<!DOCTYPE html>
<html lang="tr">
<head>
    <script src="/js/theme-init.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Veri AktarÄ±m AracÄ±</title>
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        /* Admin.css deÄŸiÅŸkenlerini kullanan modern stil */
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            font-family: 'Inter', sans-serif;
        }

        .importer-card { 
            background: var(--bg-panel); 
            padding: 40px; 
            border-radius: 16px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4); 
            text-align: center; 
            max-width: 500px; 
            width: 100%; 
        }

        h2 {
            color: var(--text-white);
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        p.text-muted {
            color: var(--text-muted);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        #status { 
            margin-top: 25px; 
            font-weight: 500; 
            font-family: 'Courier New', monospace; 
            text-align: left; 
            background: #0f172a; 
            color: #cbd5e1; 
            padding: 15px; 
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        #status.error { border-left: 4px solid var(--danger); color: #fca5a5; }
        #status.success { border-left: 4px solid var(--success); color: #86efac; }
        
        .code-path {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--gold-primary);
        }
    </style>
    <link rel="manifest" href="/manifest.json">
</head>
<body>

    <div class="importer-card">
        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸš€</div>
        <h2>Tek TÄ±kla Veri AktarÄ±mÄ±</h2>
        <p class="text-muted">
            <span class="code-path">public/seed.json</span> dosyasÄ±ndaki verileri Firestore'daki <span class="code-path">questions</span> koleksiyonuna aktarmak iÃ§in butona tÄ±klayÄ±n.
        </p>
        
        <button id="importBtn" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;">
            SorularÄ± VeritabanÄ±na Aktar
        </button>
        
        <div id="status" style="display:none;"></div>
    </div>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { showConfirm, showToast } from '../js/notifications.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const importBtn = document.getElementById('importBtn');
        const statusDiv = document.getElementById('status');

        let isRunning = false;

        onAuthStateChanged(auth, user => {
            if (!user) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'error';
                statusDiv.innerHTML = "GiriÅŸ yapÄ±lmadÄ±. LÃ¼tfen admin hesabÄ±nÄ±zla oturum aÃ§Ä±n.";
                importBtn.disabled = true;
                importBtn.classList.add('btn-secondary');
                importBtn.classList.remove('btn-primary');
            }
        });

        importBtn.addEventListener('click', async () => {
            if (isRunning) return;
            if (!auth.currentUser) {
                showToast("Devam etmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n.", "error");
                return;
            }

            const shouldImport = await showConfirm("`public/seed.json` dosyasÄ±ndaki veriler Firestore'a aktarÄ±lacak. Ä°ÅŸleme devam etmek istiyor musunuz?", {
                title: "Veri AktarÄ±mÄ±",
                confirmText: "AktarÄ±mÄ± BaÅŸlat",
                cancelText: "VazgeÃ§"
            });
            if (!shouldImport) {
                return;
            }

            isRunning = true;
            importBtn.disabled = true;
            importBtn.innerText = "Ä°ÅŸlem YÃ¼rÃ¼tÃ¼lÃ¼yor...";
            statusDiv.style.display = 'block';
            statusDiv.className = '';
            statusDiv.innerHTML = 'â³ Ä°ÅŸlem baÅŸlatÄ±ldÄ±...<br>';

            try {
                // 1. seed.json dosyasÄ±nÄ± Ã§ek
                statusDiv.innerHTML += '-> `seed.json` dosyasÄ± aranÄ±yor...<br>';
                
                // Not: seed.json dosyasÄ±nÄ±n public klasÃ¶rÃ¼nde olmasÄ± gerekir
                const response = await fetch('../seed.json');
                
                if (!response.ok) {
                    if(response.status === 404) {
                        throw new Error("`public/seed.json` dosyasÄ± bulunamadÄ±. LÃ¼tfen dosyayÄ± doÄŸru yere koyduÄŸunuzdan emin olun.");
                    }
                    throw new Error(`Dosya okuma hatasÄ± (HTTP ${response.status})`);
                }
                
                const questions = await response.json();

                if (!Array.isArray(questions)) throw new Error('JSON verisi bir dizi (array) formatÄ±nda olmalÄ±.');
                
                statusDiv.innerHTML += `-> ${questions.length} adet soru bulundu. Firestore'a yazÄ±lÄ±yor...<br>`;

                // 2. Her bir soruyu Firestore'a ekle
                const questionsCollection = collection(db, 'questions');
                let count = 0;
                
                for (const question of questions) {
                    const dataToSave = {
                        ...question,
                        createdAt: serverTimestamp(),
                        isFlaggedForReview: question.isFlaggedForReview || false
                    };
                    await addDoc(questionsCollection, dataToSave);
                    count++;
                    
                    // Her 5 soruda bir durumu gÃ¼ncelle (Performans iÃ§in)
                    if (count % 5 === 0) {
                        statusDiv.innerHTML += `<span style="opacity:0.7">- ${count}. soru eklendi...</span><br>`;
                        // Scroll en alta
                        statusDiv.scrollTop = statusDiv.scrollHeight;
                    }
                }
                
                statusDiv.innerHTML += '<br><strong class="success">âœ… BAÅARILI!</strong> TÃ¼m veriler baÅŸarÄ±yla aktarÄ±ldÄ±.';
                importBtn.className = 'btn btn-success';
                importBtn.innerText = "Ä°ÅŸlem TamamlandÄ±";

            } catch (error) {
                console.error("AktarÄ±m HatasÄ±:", error);
                statusDiv.innerHTML += `<br><strong class="error">âŒ HATA: ${error.message}</strong>`;
                importBtn.innerText = "Hata OluÅŸtu";
                importBtn.className = 'btn btn-danger';
            } finally {
                isRunning = false;
            }
        });
    </script>

</body>
</html>
