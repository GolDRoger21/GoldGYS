<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Veri AktarÄ±m AracÄ±</title>
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f7f6; }
        .importer-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 500px; width: 100%; }
        #status { margin-top: 20px; font-weight: 500; font-family: monospace; text-align: left; background: #2c3e50; color: white; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto; }
        #status.error { color: #e74c3c; }
        #status.success { color: #2ecc71; }
    </style>
</head>
<body>

    <div class="importer-card">
        <h2>ğŸš€ Tek TÄ±kla Veri AktarÄ±mÄ±</h2>
        <p class="text-muted">`seed.json` dosyasÄ±ndaki verileri Firestore'daki `questions` koleksiyonuna aktarmak iÃ§in butona tÄ±klayÄ±n.</p>
        <button id="importBtn" class="btn btn-primary btn-lg">SorularÄ± VeritabanÄ±na Aktar</button>
        <div id="status" style="display:none;"></div>
    </div>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const importBtn = document.getElementById('importBtn');
        const statusDiv = document.getElementById('status');

        let isRunning = false;

        onAuthStateChanged(auth, user => {
            if (!user) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'error';
                statusDiv.innerHTML = "HATA: LÃ¼tfen Ã¶nce admin hesabÄ±nÄ±zla giriÅŸ yapÄ±n.";
                importBtn.disabled = true;
            }
        });

        importBtn.addEventListener('click', async () => {
            if (isRunning) return;
            if (!auth.currentUser) {
                alert("LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.");
                return;
            }

            if (!confirm("Bu iÅŸlem `seed.json` dosyasÄ±ndaki verileri `questions` koleksiyonuna ekleyecektir. OnaylÄ±yor musunuz?")) {
                return;
            }

            isRunning = true;
            importBtn.disabled = true;
            importBtn.innerText = "Ä°ÅŸlem YÃ¼rÃ¼tÃ¼lÃ¼yor...";
            statusDiv.style.display = 'block';
            statusDiv.className = '';
            statusDiv.innerHTML = 'Ä°ÅŸlem baÅŸlatÄ±ldÄ±...<br>';

            try {
                // 1. seed.json dosyasÄ±nÄ± Ã§ek
                statusDiv.innerHTML += '-> `seed.json` dosyasÄ± okunuyor...<br>';
                const response = await fetch('../seed.json');
                if (!response.ok) throw new Error(`seed.json dosyasÄ± bulunamadÄ± (HTTP ${response.status})`);
                const questions = await response.json();

                if (!Array.isArray(questions)) throw new Error('JSON verisi bir dizi (array) formatÄ±nda olmalÄ±.');
                
                statusDiv.innerHTML += `-> ${questions.length} adet soru bulundu. Firestore'a yazÄ±lÄ±yor...<br>`;

                // 2. Her bir soruyu Firestore'a ekle
                const questionsCollection = collection(db, 'questions');
                for (const question of questions) {
                    // GÃ¼venlik iÃ§in, mevcut veriye ek olarak sunucu zaman damgasÄ± ekleyelim
                    const dataToSave = {
                        ...question,
                        createdAt: serverTimestamp(),
                        isFlaggedForReview: question.isFlaggedForReview || false
                    };
                    await addDoc(questionsCollection, dataToSave);
                    statusDiv.innerHTML += `<span class="success">- Soru eklendi: ${question.text.substring(0, 30)}...</span><br>`;
                }
                
                statusDiv.innerHTML += '<br><strong class="success">BAÅARILI!</strong> TÃ¼m veriler baÅŸarÄ±yla aktarÄ±ldÄ±.';
                importBtn.className = 'btn btn-success btn-lg';
                importBtn.innerText = "Ä°ÅŸlem TamamlandÄ±";

            } catch (error) {
                console.error("AktarÄ±m HatasÄ±:", error);
                statusDiv.innerHTML += `<br><strong class="error">HATA: ${error.message}</strong><br>LÃ¼tfen konsolu kontrol edin ve yÃ¶netici yetkilerinizle giriÅŸ yaptÄ±ÄŸÄ±nÄ±zdan emin olun.`;
                importBtn.innerText = "Hata OluÅŸtu";
                 importBtn.className = 'btn btn-danger btn-lg';
            } finally {
                isRunning = false;
                // Butonu tekrar aktif etme, iÅŸlem tek seferlik
            }
        });
    </script>

</body>
</html>
