<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplu YÃ¼kleme | GOLD GYS</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../styles/tokens.css">
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        .importer-wrapper {
            max-width: 800px;
            margin: 0 auto;
        }

        .status-box {
            background: #000;
            color: #0f0;
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #ef4444;
        }

        .warning {
            color: #fbbf24;
        }
    </style>
</head>

<body>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar"></aside>
    <div id="app-header-placeholder"></div>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="section-header">
                <h2>Toplu Veri YÃ¼kleme</h2>
            </div>

            <div class="importer-wrapper">
                <div class="card">
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Bu araÃ§, `seed.json` dosyasÄ±ndaki verileri Firestore veritabanÄ±na aktarÄ±r.
                        Ä°ÅŸlem sÄ±rasÄ±nda tarayÄ±cÄ±yÄ± kapatmayÄ±n.
                    </p>

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="startImportBtn" class="btn btn-primary">
                            <span class="icon">ğŸš€</span> AktarÄ±mÄ± BaÅŸlat
                        </button>
                    </div>

                    <div id="statusLog" class="status-box">
                        > HazÄ±r. BaÅŸlamak iÃ§in butona tÄ±klayÄ±n...<br>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Ortak Config ve UI Loader KullanÄ±mÄ±
        import { db } from "../js/firebase-config.js";
        import { collection, addDoc, serverTimestamp, getDocs, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initLayout } from "../js/ui-loader.js";
        import { requireAdminOrEditor } from "../js/role-guard.js";

        // Sayfa BaÅŸlangÄ±cÄ±
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. ArayÃ¼zÃ¼ YÃ¼kle
            await initLayout();

            // 2. Yetki KontrolÃ¼
            const { role } = await requireAdminOrEditor();
            if (role !== 'admin') {
                alert("Bu sayfaya sadece YÃ¶neticiler eriÅŸebilir.");
                window.location.href = 'index.html';
            }
        });

        // Ä°Ã§e AktarÄ±m MantÄ±ÄŸÄ±
        const importBtn = document.getElementById('startImportBtn');
        const statusDiv = document.getElementById('statusLog');
        let isRunning = false;

        importBtn.addEventListener('click', async () => {
            if (isRunning) return;

            if (!confirm("DÄ°KKAT: VeritabanÄ±na toplu veri eklenecek. Devam edilsin mi?")) return;

            isRunning = true;
            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="icon">â³</span> Ä°ÅŸleniyor...';
            statusDiv.innerHTML = '> ğŸ”„ Veri dosyasÄ± (seed.json) okunuyor...<br>';

            try {
                // seed.json dosyasÄ±nÄ± root'tan Ã§ekiyoruz
                const response = await fetch('/seed.json');
                if (!response.ok) throw new Error("seed.json dosyasÄ± bulunamadÄ±! (Ana dizinde olduÄŸundan emin olun)");

                const data = await response.json();
                statusDiv.innerHTML += `> âœ… Dosya okundu. ${data.length} adet soru bulundu.<br>`;
                statusDiv.innerHTML += `> ğŸš€ Firestore yazma iÅŸlemi baÅŸlÄ±yor...<br>`;

                const questionsCollection = collection(db, "questions");
                let count = 0;
                let batch = writeBatch(db); // Batch kullanÄ±mÄ± (Daha hÄ±zlÄ±)
                let batchCount = 0;

                for (const question of data) {
                    const docRef = doc(questionsCollection); // Yeni ID oluÅŸtur

                    const dataToSave = {
                        ...question,
                        createdAt: serverTimestamp(),
                        isFlaggedForReview: false,
                        searchKeywords: generateKeywords(question.text) // Basit arama keywordleri
                    };

                    batch.set(docRef, dataToSave);
                    batchCount++;
                    count++;

                    // Firestore Batch limiti 500'dÃ¼r. Biz 400'de bir gÃ¶nderelim.
                    if (batchCount >= 400) {
                        await batch.commit();
                        statusDiv.innerHTML += `<span class="success">> ${count} veri kaydedildi (Batch)...</span><br>`;
                        statusDiv.scrollTop = statusDiv.scrollHeight;
                        batch = writeBatch(db); // Yeni batch
                        batchCount = 0;
                    }
                }

                // KalanlarÄ± gÃ¶nder
                if (batchCount > 0) {
                    await batch.commit();
                }

                statusDiv.innerHTML += '<br><strong class="success">âœ… Ä°ÅLEM TAMAMLANDI!</strong><br>';
                statusDiv.innerHTML += `> Toplam ${count} soru baÅŸarÄ±yla veritabanÄ±na eklendi.`;

                importBtn.className = 'btn btn-success';
                importBtn.innerHTML = '<span class="icon">âœ“</span> TamamlandÄ±';

            } catch (error) {
                console.error("Hata:", error);
                statusDiv.innerHTML += `<br><strong class="error">âŒ HATA: ${error.message}</strong><br>`;
                importBtn.innerHTML = 'Tekrar Dene';
                importBtn.disabled = false;
            } finally {
                isRunning = false;
            }
        });

        // Basit Arama Keyword Ãœretici (Opsiyonel)
        function generateKeywords(text) {
            if (!text) return [];
            return text.toLowerCase().split(' ').filter(word => word.length > 2).slice(0, 10);
        }
    </script>
</body>

</html>