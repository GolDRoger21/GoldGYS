rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonksiyonlar ---
    function signedIn() { return request.auth != null; }
    
    // Admin: Token'ında admin yetkisi olan
    function isAdmin() { 
      return signedIn() && (request.auth.token.admin == true || request.auth.token.role == 'admin'); 
    }
    
    // Editör: Admin VEYA Token'ında editor yetkisi olan
    function isEditor() { 
      return isAdmin() || (signedIn() && (request.auth.token.editor == true || request.auth.token.role == 'editor')); 
    }

    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }

    // --- KULLANICILAR ---
    match /users/{uid} {
      // Adminler herkesi okur, kullanıcı sadece kendini okur
      allow read: if isSelf(uid) || isAdmin();
      // Adminler statü/rol güncelleyebilir, kullanıcı sadece profil bilgilerini (kendi kısıtlı alanlarını)
      allow write: if isAdmin() || isSelf(uid); 
    }

    // --- İÇERİK YÖNETİMİ (Konular, Testler, Sorular) ---
    // Konular (topics)
    match /topics/{topicId} {
      allow read: if signedIn();
      allow write: if isEditor(); // Ekleme/Düzenleme/Silme: Editör ve Admin
    }
    
    // Testler (tests) - EKSİKTİ EKLENDİ
    match /tests/{testId} {
      allow read: if signedIn();
      allow write: if isEditor();
    }
    
    // Sorular (questions) - Subcollection ise
    match /questions/{questionId} { // Veya collectionGroup kullanılıyorsa ona göre ayarlanmalı
      allow read: if signedIn();
      allow write: if isEditor();
    }

    // --- RAPORLAR (reports) ---
    // Hatalı soru bildirimleri vs.
    match /reports/{reportId} {
      allow create: if signedIn(); // Her üye rapor oluşturabilir
      allow read, update, delete: if isEditor(); // Editörler raporları okuyup işlem yapabilir
    }
    
    // --- SİSTEM ---
    match /system/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin(); // Sadece Admin
    }

    // --- VARSAYILAN (Güvenlik Ağı) ---
    match /{document=**} {
      allow read, write: if false; // Açıkça belirtilmeyen her şeyi kapat
    }
  }
}
